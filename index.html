<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Ù…ÙƒØªØ¨Ø© DOMPurify Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†ØµÙˆØµ Ù…Ù† Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø®Ø¨ÙŠØ«Ø© -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ø¹Ø±Ù Ù…Ù†ØªØ¬Ùƒ</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <!-- Ù…ÙƒØªØ¨Ø© SheetJS Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
    /* Ø²Ø± Ø£ØµØºØ± ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
    @media (max-width:700px) {
        #bundles-list .bundle-item { padding: 8px; }
        #bundles-list .bundle-delete-btn { padding: 6px 8px; min-width: 34px; height: 30px; border-radius: 6px; }
    }
    /* ---ØªÙ†Ø³ÙŠÙ‚ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© --- */
#login-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background-color: var(--dark-sidebar); /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© */
    z-index: 99999; /* ØªØ¸Ù‡Ø± ÙÙˆÙ‚ ÙƒÙ„ Ø´ÙŠØ¡ */
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px);
}

.login-box {
    background: white;
    padding: 40px;
    border-radius: 15px;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    text-align: center;
    animation: zoomIn 0.3s ease;
}

.login-box h2 {
    color: var(--main-blue);
    margin-bottom: 20px;
    font-size: 24px;
}

.login-box .form-group {
    text-align: right;
    margin-bottom: 15px;
}

.login-box input {
    height: 45px;
    font-size: 14px;
    background: #f8fafc;
    border: 2px solid #e2e8f0;
}

.login-box input:focus {
    border-color: var(--main-blue);
}

.login-footer {
    margin-top: 20px;
    font-size: 12px;
    color: #64748b;
}

/* Ø­Ø±ÙƒØ© Ø¸Ù‡ÙˆØ± Ø§Ù„Ù†Ø§ÙØ°Ø© */
@keyframes zoomIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}
        :root {
            --main-blue: #1a73e8;
            --dark-sidebar: #111827;
            --bg-body: #f1f5f9;
            --white: #ffffff;
            --text-main: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #cbd5e1;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background-color: var(--bg-body); margin: 0; display: flex; color: var(--text-main); min-height: 100vh; font-size: 13px; }

        .sidebar { width: 200px; background: var(--dark-sidebar); color: white; position: fixed; height: 100vh; right: 0; padding: 10px; z-index: 1000; transition: 0.3s; }
        .sidebar-brand { font-size: 14px; font-weight: 800; text-align: center; margin-bottom: 15px; color: #38bdf8; border-bottom: 1px solid #1e293b; padding-bottom: 10px; }
        .nav-menu { list-style: none; padding: 0; }
        .nav-link {
            display: flex; align-items: center; gap: 8px; padding: 8px 10px; color: #94a3b8;
            text-decoration: none; border-radius: 6px; transition: 0.2s; cursor: pointer; border: none; background: transparent; width: 100%; font-size: 12px; font-weight: 600; margin-bottom: 4px;
        }
        .nav-link:hover, .nav-link.active { background: #1e293b; color: white; }
        .nav-link.active { background: var(--main-blue); }

        .main-content { flex: 1; margin-right: 200px; padding: 15px; width: calc(100% - 200px); }
        
        .stats-grid { display: flex; gap: 10px; margin-bottom: 15px; }
        .stat-card { 
            background: var(--white); padding: 8px 12px; border-radius: 8px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; align-items: center; 
            gap: 10px; border: 1px solid var(--border); flex: 1;
        }
        .stat-icon { font-size: 16px; padding: 6px; border-radius: 6px; }
        .stat-value { font-size: 16px; font-weight: 800; display: block; color: #0f172a; line-height: 1; }
        .stat-label { font-size: 10px; color: #64748b; font-weight: 600; }

        .panel { 
            background: var(--white); border-radius: 10px; padding: 15px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: none; 
            max-width: 100%; margin: 0 auto; border: 1px solid var(--border);
        }
        .panel.active { display: block; }

        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .full-width { grid-column: span 2; }
        .form-group { margin-bottom: 8px; position: relative; }
        label { display: block; margin-bottom: 3px; font-weight: 700; font-size: 11px; color: #475569; }
        input, textarea, select { 
            width: 100%; padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); 
            outline: none; transition: 0.2s; font-size: 12px; background: #f8fafc; height: 34px;
        }
        textarea { height: auto; }
        input:focus { border-color: var(--main-blue); background: #fff; }

        #editor-container { height: 120px; border-radius: 0 0 6px 6px; font-size: 13px; }
        .ql-toolbar { padding: 4px !important; border-radius: 6px 6px 0 0; }
        
        .btn-group { display: flex; gap: 6px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #e2e8f0; }
        .btn { 
            border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; 
            font-weight: bold; font-size: 11px; display: flex; align-items: center; justify-content: center;
            gap: 5px; color: white; transition: 0.2s; height: 32px; flex: 1;
        }
        .btn-save { background: var(--success); }
        .btn-update { background: var(--warning); }
        .btn-red { background: var(--danger); }
        .btn-gray { background: #64748b; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        #suggestions { 
            position: absolute; top: 100%; left: 0; right: 0; background: white; 
            z-index: 1000; border-radius: 0 0 6px 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            max-height: 150px; overflow-y: auto; display: none; border: 1px solid var(--border);
        }
        .sug-item { padding: 6px 10px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 11px; display: flex; justify-content: space-between; }
        .sug-item:hover { background: #eff6ff; }

        .preview-flex { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .preview-card { 
            width: 100%; max-width: 250px; min-height: 50px; border-radius: 6px; border: 1px solid #e2e8f0; 
            position: relative; background: #f1f5f9; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        .preview-card img, .preview-card video, .preview-card iframe { width: 100%; height: auto; object-fit: cover; border-radius: 5px; }
        .remove-badge { 
            position: absolute; top: 2px; right: 2px; background: var(--danger); 
            color: white; border: none; border-radius: 50%; width: 16px; height: 16px; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; 
            font-size: 10px; font-weight: bold; z-index: 10;
        }

        .color-item-card {
            background: #fff; border: 1px solid #ddd; padding: 5px 10px; 
            border-radius: 20px; display: flex; align-items: center; gap: 8px; 
            font-size: 11px; font-weight: bold;
        }
        .color-preview-dot { width: 15px; height: 15px; border-radius: 50%; border: 1px solid #ccc; }

        @media (max-width: 900px) {
            .sidebar { width: 50px; padding: 5px; }
            .sidebar-brand, .nav-link span { display: none; }
            .main-content { margin-right: 50px; width: calc(100% - 50px); }
            .form-grid { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
            .btn-group { flex-wrap: wrap; }
        }
		/* ØªØ£Ø«ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ… Ø¹Ù„Ù‰ ÙƒØ±ÙˆØª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
.stat-card.clickable {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1.5px solid transparent;
}
.stat-card.clickable:hover {
    transform: translateY(-5px);
    border-color: var(--warning);
    box-shadow: 0 5px 15px rgba(245, 158, 11, 0.2);
    background: #fffbeb; /* ØªØºÙŠÙŠØ± Ø¨Ø³ÙŠØ· ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© */
}
    </style>
</head>
<body>
<!-- Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ© -->
<div id="login-overlay">
    <div class="login-box">
        <div style="font-size: 50px; color: var(--main-blue); margin-bottom: 10px;">
            <i class="fas fa-shield-alt"></i>
        </div>
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <p style="color:#666; margin-bottom:20px; font-size:13px;">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</p>
        
        <div class="form-group">
            <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input type="email" id="popup-email" placeholder="admin@example.com">
        </div>
        <div class="form-group">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input type="password" id="popup-pass" placeholder="********">
        </div>
        
        <button class="btn btn-save" onclick="handlePopupLogin()" style="width:100%; height:45px; font-size:14px; margin-top:10px;">
            <i class="fas fa-sign-in-alt"></i> Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†
        </button>
        
        <div id="popup-msg" style="margin-top:15px; font-weight:bold; font-size:12px;"></div>
        
        <div class="login-footer">
            Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª - Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ† 2026
        </div>
    </div>
</div>
<aside class="sidebar">
    <div class="sidebar-brand"><i class="fas fa-layer-group"></i> <span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø·ÙˆØ±</span></div>
    <ul class="nav-menu">
        <li><button class="nav-link active" onclick="showPanel('p-products', this)"><i class="fas fa-box"></i> <span>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span></button></li>
        <li><button class="nav-link" onclick="showPanel('p-bundles', this)"><i class="fas fa-gift"></i> <span>Ø£ÙƒÙˆØ§Ø¯ Ø¨Ø§Ù†Ø¯Ù„</span></button></li>
        <li><button class="nav-link" onclick="showPanel('p-ads', this)"><i class="fas fa-ad"></i> <span>Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</span></button></li>
        <li><button class="nav-link" onclick="showPanel('p-notif', this)"><i class="fas fa-bullhorn"></i> <span>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span></button></li>
        <li><button class="nav-link" onclick="showPanel('p-appearance-pro', this)"><i class="fas fa-palette"></i><span>Ø§Ù„Ù…Ø¸Ù‡Ø±</span></button></li>
        <li><button class="nav-link" onclick="showPanel('p-settings', this)"><i class="fas fa-cogs"></i> <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></button></li>
        <li><button class="nav-link" onclick="showPanel('p-sales-report', this)"><i class="fas fa-chart-line"></i> <span>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span></button></li>
        <li><button class="nav-link" onclick="showPanel('p-analytics', this)"><i class="fas fa-chart-pie"></i> <span>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span></button></li>
        <li><button class="nav-link" onclick="showPanel('p-maintenance', this)"><i class="fas fa-tools"></i> <span>ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©</span></button></li>
        <li><button class="nav-link" id="nav-users" onclick="showPanel('p-users', this)"><i class="fas fa-users-cog"></i> <span>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</span></button></li>
<li><button class="nav-link" onclick="handleLogout()" style="color: #ef4444; border-top: 1px solid #1e293b; margin-top: 5px;"><i class="fas fa-sign-out-alt"></i> <span>ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</span></button></li>

    </ul>
</aside>

<main class="main-content">
    <div class="stats-grid">
        <div class="stat-card">
            <i class="fas fa-database stat-icon" style="color:#1a73e8; background:#eff6ff;"></i>
            <div><span class="stat-value" id="count-total">0</span><span class="stat-label">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span></div>
        </div>
        <div class="stat-card">
            <i class="fas fa-tags stat-icon" style="color:#10b981; background:#f0fdf4;"></i>
            <div><span class="stat-value" id="count-cats">0</span><span class="stat-label">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span></div>
        </div>
        <div class="stat-card clickable" onclick="filterNoImageProducts()" title="Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙŠ Ø¨Ù„Ø§ ØµÙˆØ±">
    <i class="fas fa-image-slash stat-icon" style="color:#f59e0b; background:#fffbeb;"></i>
    <div>
	</div>
        <span class="stat-value" id="count-no-img">0</span>
        <span class="stat-label">Ø¨Ù„Ø§ ØµÙˆØ± </span>
    </div>
    </div>
    <section id="p-products" class="panel active">
        <div class="form-group">
            <label>Ø¨Ø­Ø« Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© (ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬)</label>
            <input type="text" id="productId" oninput="liveSearch(this.value)" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§...." style="font-weight:bold; color:var(--main-blue);">
            <div id="suggestions"></div>
        </div>

        <div class="form-grid">
            <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input type="text" id="name"></div>
            <div class="form-group"><label>Ø§Ù„Ø³Ø¹Ø±</label><input type="text" id="price"></div>
            <div class="form-group full-width"><label>Ø§Ù„Ù‚Ø³Ù… / Ø§Ù„ØªØµÙ†ÙŠÙ</label><input type="text" id="p-category"></div>
            
            <div class="form-group full-width">
                <label>Ø§Ù„ØªÙØ§ØµÙŠÙ„</label>
                <div id="editor-container"></div>
            </div>

<!-- Ø¨Ø¯Ø§ÙŠØ© ÙƒÙˆØ¯ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø¹Ø¯Ù„ Ù…Ø¹ Ø²Ø± Ø§Ù„Ø±ÙØ¹ -->
<div class="form-group full-width">
    <label>Ø§Ù„ØµÙˆØ± (Ø±ÙˆØ§Ø¨Ø· Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©)</label>
    <div style="display: flex; gap: 5px; align-items: flex-start;">
        <!-- Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ -->
        <textarea id="images" oninput="syncPreviews()" rows="1" placeholder="http://... , http://..." style="flex: 1;"></textarea>
        
        <!-- Ø²Ø± Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
        <input type="file" id="cloudinaryInput" accept="image/*" style="display: none;" onchange="uploadImageToCloudinary(this)">
        <button type="button" onclick="document.getElementById('cloudinaryInput').click()" class="btn" style="background: #e91e63; width: auto; padding: 0 15px; height: 34px;">
            <i class="fas fa-cloud-upload-alt"></i> Ø±ÙØ¹ ØµÙˆØ±Ø©
        </button>
    </div>
    
    <!-- Ù…Ø¤Ø´Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹ -->
    <div id="cl-upload-status" style="display:none; font-size:11px; font-weight:bold; margin-top:5px;"></div>
    
    <!-- Ù…Ù†Ø·Ù‚Ø© Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ± -->
    <div id="imagePreview" class="preview-flex"></div>
</div>
<!-- Ù†Ù‡Ø§ÙŠØ© ÙƒÙˆØ¯ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø¹Ø¯Ù„ -->->
            <div class="form-group full-width">
                <label>ÙÙŠØ¯ÙŠÙˆ (ÙŠÙˆØªÙŠÙˆØ¨ Ø£Ùˆ Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±)</label>
                <input type="text" id="video" oninput="syncVideo()" placeholder="https://www.youtube.com/watch?v=...">
                <div id="videoPreview" class="preview-flex" style="margin-top:10px;"></div>
            </div>
        </div>
        
<!-- Ø¨Ø¯Ø§ÙŠØ© Ù‚Ø³Ù… Ø§Ù„Ø£Ù„ÙˆØ§Ù† -->
<div class="form-group" style="background:#f9f9f9; padding:15px; border-radius:10px; border:1px solid #eee; margin-top:10px;">
    <label style="color:#1a73e8;">ğŸ¨ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ù†ØªØ¬</label>
    
    <div style="display:flex; gap:10px; margin-bottom:10px; align-items: center;">
        <!-- Ø§Ø³Ù… Ø§Ù„Ù„ÙˆÙ† -->
        <input id="cName" placeholder="Ø§Ù„Ø§Ø³Ù… (Ù…Ø«Ù„Ø§Ù‹: Ø£Ø­Ù…Ø±)" style="flex:1;">
        
        <!-- ÙƒÙˆØ¯ Ø§Ù„Ù„ÙˆÙ† -->
        <input type="color" id="cCode" style="width:50px; height:34px; padding:0; cursor: pointer;">
        
        <!-- Ù‚Ø³Ù… Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© ÙˆØ²Ø± Ø§Ù„Ø±ÙØ¹ -->
        <div style="flex:2; display: flex; gap: 5px;">
            <input id="cImg" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©" style="width:100%;">
            
            <!-- Ø²Ø± Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ø®ÙÙŠ ÙˆØ§Ù„Ø¸Ø§Ù‡Ø± -->
            <input type="file" id="colorUploadInput" accept="image/*" style="display: none;" onchange="uploadColorImage(this)">
            <button type="button" onclick="document.getElementById('colorUploadInput').click()" class="btn" style="background: #e91e63; width: 50px; padding: 0; display: flex; align-items: center; justify-content: center;" title="Ø±ÙØ¹ ØµÙˆØ±Ø© Ù„Ù„ÙˆÙ†">
                <i class="fas fa-cloud-upload-alt"></i>
            </button>
        </div>

        <!-- Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© -->
        <button class="btn btn-save" onclick="addColorItem()" style="width:auto; padding:0 15px;">Ø¥Ø¶Ø§ÙØ©</button>
    </div>

    <!-- Ù…Ø¤Ø´Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹ -->
    <div id="color-upload-status" style="display:none; font-size:11px; font-weight:bold; margin-bottom:10px; text-align:center;"></div>

    <div id="colorsPreview" class="preview-flex"></div>
</div>
<!-- Ù†Ù‡Ø§ÙŠØ© Ù‚Ø³Ù… Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø¹Ø¯Ù„ -->

        <div class="btn-group">
            <button id="mainBtn" class="btn btn-save" onclick="commitProduct()"><i class="fas fa-plus"></i> Ø­ÙØ¸ Ø¬Ø¯ÙŠØ¯</button>
            <button class="btn btn-red" onclick="removeProduct()"><i class="fas fa-trash"></i> Ø­Ø°Ù</button>
            <button class="btn btn-gray" onclick="clearForm()"><i class="fas fa-eraser"></i> ØªÙØ±ÙŠØº</button>
        </div>
<!-- Ù‚Ø³Ù… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„ (Ø±ÙØ¹ + Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ) -->
        <div class="btn-group" style="margin-top: 15px; border-top: 2px dashed #cbd5e1; padding-top: 15px; background: #f8fafc; padding: 10px; border-radius: 8px;">
            <div style="width:100%; text-align:center; margin-bottom:5px; font-weight:bold; color:#1e293b;">ğŸ“¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Excel)</div>
            
            <input type="file" id="productExcelUpload" accept=".xlsx, .xls, .csv" style="display:none" onchange="handleProductExcel(this)">
            
            <!-- Ø²Ø± Ø§Ù„Ø±ÙØ¹ -->
            <button onclick="document.getElementById('productExcelUpload').click()" class="btn" style="background:#217346; color:white; flex:2;">
                <i class="fas fa-file-excel"></i> Ø±ÙØ¹ Ù…Ù„Ù
            </button>
            
            <!-- Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ (Ø§Ù„Ø¬Ø¯ÙŠØ¯) -->
            <button onclick="downloadProductsBackup()" class="btn" style="background:#f59e0b; color:white; flex:2;">
                <i class="fas fa-file-export"></i> Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ
            </button>

            <!-- Ø²Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ -->
            <button onclick="downloadProductTemplate()" class="btn btn-gray" title="ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ ÙØ§Ø±Øº" style="flex:1;">
                <i class="fas fa-download"></i> Ù†Ù…ÙˆØ°Ø¬
            </button>
        </div>
        <div id="prod-upload-status" style="margin-top:10px; font-size:12px; font-weight:bold; text-align:center; display:none;"></div>
    </section>
    <section id="p-notif" class="panel">
        <h3 style="margin:0 0 10px 0; font-size:14px;">ğŸ”” Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚</h3>
        <div class="form-group"><label>Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</label><input type="text" id="notifyMsg"></div>
        <div class="form-grid">
            <div class="form-group">
                <label>Ø§Ù„Ù†ÙˆØ¹</label>
                <select id="notifyType">
                    <option value="info">Ø£Ø²Ø±Ù‚</option>
                    <option value="warning">Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ</option>
                    <option value="danger">Ø£Ø­Ù…Ø±</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
                <select id="notifStatus">
                    <option value="true">ØªÙØ¹ÙŠÙ„</option>
                    <option value="false">Ø¥Ø®ÙØ§Ø¡</option>
                </select>
            </div>
        </div>
        <button onclick="sendNotification()" class="btn btn-update" style="width:100%; margin-top:10px;">ØªØ­Ø¯ÙŠØ«</button>
    </section>

    <section id="p-ads" class="panel">
        <h3 style="margin:0 0 15px 0; font-size:14px; border-bottom:1px solid #eee; padding-bottom:10px;">
            ğŸ“¢ Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù… (AdSense & Popups)
        </h3>
        
        <div class="form-group">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
            <select id="adSourceType" onchange="toggleAdInputs()" style="background:#f0f9ff; border:1px solid #bae6fd;">
                <option value="image">ØµÙˆØ±Ø© (Banner Image)</option>
                <option value="code">ÙƒÙˆØ¯ Ø¨Ø±Ù…Ø¬ÙŠ (AdSense / HTML)</option>
            </select>
        </div>

        <div id="input-image-group">
            <div class="form-group"><label>Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©</label><input type="text" id="adImg" placeholder="https://..."></div>
            <div class="form-group"><label>Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ (Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±)</label><input type="text" id="adLink" placeholder="https://..."></div>
        </div>

        <div id="input-code-group" style="display:none;">
            <div class="form-group full-width">
                <label>ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (HTML / Script)</label>
                <textarea id="adHtmlCode" rows="4" placeholder="Ø¶Ø¹ ÙƒÙˆØ¯ AdSense Ø£Ùˆ HTML Ù‡Ù†Ø§..." style="direction:ltr; font-family:monospace;"></textarea>
            </div>
        </div>

        <div class="form-grid">
            <div class="form-group">
                <label>Ù…ÙƒØ§Ù† Ø§Ù„Ø¸Ù‡ÙˆØ±</label>
                <select id="adPosition" onchange="toggleTimerInput()">
                    <option value="popup">Ù†Ø§ÙØ¸Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© (Popup)</option>
                    <option value="top_bar">Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ (Top Bar)</option>
                    <option value="below_search">Ø£Ø³ÙÙ„ Ø§Ù„Ø¨Ø­Ø« (Below Search)</option>
                    <option value="footer">Ø£Ø³ÙÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Footer)</option>
                </select>
            </div>
            
            <div class="form-group" id="timer-group">
                <label>Ø¥ØºÙ„Ø§Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ (Ø«Ø§Ù†ÙŠØ©)</label>
                <input type="number" id="adTimer" placeholder="0 = Ù„Ø§ ÙŠØºÙ„Ù‚" value="0">
            </div>

            <div class="form-group">
                <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
                <select id="adStatus">
                    <option value="true">ØªÙØ¹ÙŠÙ„</option>
                    <option value="false">Ø¥ÙŠÙ‚Ø§Ù</option>
                </select>
            </div>
        </div>
    <button onclick="updateAds()" class="btn btn-save" style="width:100%; margin-top:15px;">
            <i class="fas fa-rocket"></i> ØªØ­Ø¯ÙŠØ« ÙˆÙ†Ø´Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        </button>
    </section>

    <section id="p-appearance-pro" class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #f1f5f9; padding-bottom:10px; margin-bottom:15px;">
         <h3 style="margin:0; font-size:14px;"><i class="fas fa-palette"></i> ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø¸Ù‡Ø± ÙˆØ§Ù„Ù‡ÙˆÙŠØ©</h3>
    </div>
    
    <h4 style="font-size:11px; color:var(--main-blue); margin-bottom:10px;">ğŸ‘¤ Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø·ÙˆØ± ÙˆØ§Ù„Ù„ÙˆØ¬Ùˆ</h4>
    <div class="form-grid">
        <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø·ÙˆØ±</label><input type="text" id="devName"></div>
        <div class="form-group"><label>Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø·ÙˆØ±</label><input type="text" id="devPhone" placeholder="2012XXXXXXXX"></div>
<div style="display:flex; gap:10px; margin-top:10px;">
    <button onclick="saveDevInfoOnly()" class="btn" style="background-color: #075e54; flex:3;">
        <i class="fab fa-whatsapp"></i> Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ± ÙÙ‚Ø·
    </button>
    </div>
    <button onclick="resetToDefault('dev')" class="btn" style="background-color: #64748b; flex:1;" title="Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ">
        <i class="fas fa-undo-alt"></i>
    </button>
</div>
<hr style="border:0; border-top:1px dashed #cbd5e1; margin:15px 0;">
<h4 style="font-size:11px; color:var(--main-blue); margin-bottom:10px;">ğŸ’« Ø­Ø±ÙƒØ© Ø§Ù„Ø´Ø¹Ø§Ø± (Ø§Ù„Ù„ÙˆØ¬Ùˆ)</h4>
 <div class="form-group full-width"><label>Ø±Ø§Ø¨Ø· Ø§Ù„Ù„ÙˆØ¬Ùˆ</label><input type="text" id="logoUrl"></div>
    </div>
<div class="form-grid">
    <div class="form-group full-width">
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©</label>
        <div style="display:flex; gap:10px;">
            <select id="logoAnimType" style="flex:1;">
                <option value="none">Ø¨Ø¯ÙˆÙ† Ø­Ø±ÙƒØ© (Ø«Ø§Ø¨Øª)</option>
                <option value="pulse">Ù†Ø¨Ø¶ (Pulse)</option>
                <option value="float">Ø¹Ø§Ø¦Ù… (Float)</option>
                <option value="rotate">Ø¯ÙˆØ±Ø§Ù† (Rotate)</option>
            </select>
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
<button onclick="saveLogoData()" class="btn btn-update">Ø­ÙØ¸ Ø§Ù„Ù„ÙˆØ¬Ùˆ ÙˆØ§Ù„Ø­Ø±ÙƒØ©</button>
    </div>
    </div>
    <button onclick="resetToDefault('logo')" class="btn" style="background-color: #64748b; flex:1;" title="Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ">
        <i class="fas fa-undo-alt"></i>
    </button>
</div>
    <hr style="border:0; border-top:1px dashed #cbd5e1; margin:15px 0;">

    <h4 style="font-size:11px; color:var(--warning); margin-bottom:10px;">ğŸ” Ø£Ù„ÙˆØ§Ù† Ø²Ø± Ø§Ù„Ø¨Ø­Ø«</h4>
    <div class="form-grid">
        <div class="form-group"><label>Ø®Ù„ÙÙŠØ© Ø§Ù„Ø²Ø±</label><input type="color" id="searchBtnBg"></div>
        <div class="form-group"><label>Ù„ÙˆÙ† Ø§Ù„Ù†Øµ/Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©</label><input type="color" id="searchBtnColor"></div>
       <div style="display:flex; gap:10px; margin-top:10px;">
    <button onclick="saveSearchBtnColorsOnly()" class="btn" style="background-color: var(--main-blue); flex:3;">
        <i class="fas fa-paint-brush"></i> Ø­ÙØ¸ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø²Ø± 
    </button>
    </div>
    <button onclick="resetToDefault('searchBtn')" class="btn" style="background-color: #64748b; flex:1;" title="Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ">
        <i class="fas fa-undo-alt"></i>
    </button>
</div>
    <hr style="border:0; border-top:1px dashed #cbd5e1; margin:15px 0;">

    <h4 style="font-size:11px; color:var(--success); margin-bottom:10px;">ğŸ“ Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ£Ù„ÙˆØ§Ù† Ø§Ù„Ù†ØµÙˆØµ</h4>
    <div class="form-grid">
        <div class="form-group"><label>Ù„ÙˆÙ† Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†</label><input type="color" id="titleColor"></div>
        <div class="form-group"><label>Ù„ÙˆÙ† Ø§Ù„ØªÙØ§ØµÙŠÙ„</label><input type="color" id="detailsColor"></div>
        <div class="form-group">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·</label>
            <select id="appFont">
                <option value="'Cairo', sans-serif">Cairo (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ)</option>
                <option value="'Almarai', sans-serif">Almarai</option>
                <option value="'Tajawal', sans-serif">Tajawal</option>
            </select>
        </div>
        <div class="form-group">
            <label>Ø­Ø±ÙƒØ© Ø§Ù„ÙƒØ±ÙˆØª</label>
            <select id="cardAnim">
                <option value="slideInUp">Slide Up</option>
                <option value="zoomIn">Zoom In</option>
            </select>
        </div>
    </div>
<div style="display:flex; gap:10px; margin-top:15px;">
    <button onclick="saveAppearanceData()" class="btn btn-update" style="flex:3;">
        <i class="fas fa-save"></i> Ø­ÙØ¸
         (Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù†)
    </button>
    
    <button onclick="resetAppearanceToDefault()" class="btn" style="background-color: #64748b; flex:1;" title="Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ">
        <i class="fas fa-undo-alt"></i> Ø§Ø³ØªØ¹Ø§Ø¯Ø©
    </button>
</div>

</section>

    <section id="p-settings" class="panel">
        <h3 style="margin:0 0 10px 0; font-size:14px;">ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØµÙ†Ø¹</h3>
        
        <p style="font-size:12px; color:#666; margin-bottom:15px;">Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø¥Ø°Ø§ ÙˆØ§Ø¬Ù‡Øª Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„ØªØµÙ…ÙŠÙ….</p>
        
        <div class="btn-group" style="flex-direction:column;">
             <button class="btn btn-gray" onclick="resetAppearanceToDefault()">
                <i class="fas fa-paint-brush"></i> Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø£Ù„ÙˆØ§Ù† ÙˆÙ„ÙˆØ¬Ùˆ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            </button>
            <button class="btn btn-red" onclick="resetAllConfig()">
                <i class="fas fa-bomb"></i> Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø§Ù„Ù…Ø¸Ù‡Ø± ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª)
            </button>
        </div>
    </section>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.js">
</script>
<section id="p-maintenance" class="panel">
    <h3 style="margin:0 0 5px 0; font-size:14px; border-bottom:1px solid #eee; padding-bottom:10px;">
        â›” Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©
    </h3>
    </div>
    <div class="form-group">
        <label>Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
        <select id="maintStatus" style="background:#fff3cd; border-color:#ffeeba;">
            <option value="false">Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ âœ…</option>
            <option value="true">ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø© (Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆÙ‚Ø¹) â›”</option>
        </select>
    </div>
    <div class="form-group full-width">
        <label>Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© Ù„Ù„Ø²ÙˆØ§Ø±</label>
        <textarea id="maintMsg" rows="3" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØªØ­Øª Ø§Ù„ØµÙŠØ§Ù†Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ø³Ù†Ø¹ÙˆØ¯ Ù‚Ø±ÙŠØ¨Ø§Ù‹..."></textarea>
    </div>
    <button onclick="updateMaintenance()" class="btn btn-red" style="width:100%; margin-top:15px;">
        <i class="fas fa-check-circle"></i> Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©
    </button>
</section>
<section id="p-bundles" class="panel">
        <h3 style="margin:0 0 15px 0; font-size:14px; border-bottom:1px solid #eee; padding-bottom:10px;">
            ğŸ Ø¥Ø¯Ø§Ø±Ø© Ø£ÙƒÙˆØ§Ø¯ Ø¨Ø§Ù†Ø¯Ù„ ÙˆØ§Ù„Ø¹Ø±ÙˆØ¶
        </h3>
        
        <!-- Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ÙŠØ¯ÙˆÙŠ (ÙƒÙ…Ø§ Ù‡Ùˆ) -->
        <div class="form-grid">
            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
                <input type="text" id="bundleName" placeholder="Ù…Ø«Ø§Ù„: Ø®ØµÙ… Ø«Ù„Ø§Ø¬Ø§Øª Ø´Ø§Ø±Ø¨">
            </div>
            <div class="form-group">
                <label>Ø§Ù„ÙƒÙˆØ¯ (Code)</label>
                <input type="text" id="bundleCode" placeholder="Ù…Ø«Ø§Ù„: SHARP2026" style="font-family:monospace; color:var(--main-blue); font-weight:bold;">
            </div>
            <div class="form-group full-width">
                <label>Ø§Ù„ØªÙØ§ØµÙŠÙ„ / Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                <input type="text" id="bundleDesc" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø§Ø±ÙŠ Ø­ØªÙ‰ Ù†ÙØ§Ø° Ø§Ù„ÙƒÙ…ÙŠØ©">
            </div>
        </div>

        <div class="btn-group" style="margin-top:15px; border-top:none;">
            <!-- Ø²Ø± Ø§Ù„Ù†Ø´Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ -->
            <button onclick="addBundle()" class="btn btn-save" style="flex:2;">
                <i class="fas fa-plus-circle"></i> Ù†Ø´Ø± ÙŠØ¯ÙˆÙŠ
            </button>
            
            <!-- Ø²Ø± Ø±ÙØ¹ Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
            <input type="file" id="excelUpload" accept=".xlsx, .xls, .csv" style="display:none" onchange="handleExcelUpload(this)">
            <button onclick="document.getElementById('excelUpload').click()" class="btn" style="background:#217346; color:white; flex:2;">
                <i class="fas fa-file-excel"></i> Ø±ÙØ¹ Ø´ÙŠØª Ø¥ÙƒØ³ÙŠÙ„
            </button>
            
            <!-- Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ -->
            <button onclick="downloadTemplate()" class="btn btn-gray" title="ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ ÙØ§Ø±Øº" style="flex:1;">
                <i class="fas fa-download"></i> Ù†Ù…ÙˆØ°Ø¬
            </button>
        </div>
        
        <!-- Ø´Ø±ÙŠØ· Ø­Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹ -->
        <div id="upload-status" style="margin-top:10px; font-size:12px; font-weight:bold; text-align:center; display:none;"></div>

        <h4 style="margin-top:20px; font-size:12px; color:#666;">ğŸ“‹ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</h4>
        <div id="bundles-list" style="margin-top:10px; display:grid; gap:10px;"></div>
    </section>
    <!-- Ù‚Ø³Ù… ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª -->
    <section id="p-sales-report" class="panel">
        <h3 style="border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ù…Ù† Ø§Ù„ÙØ±ÙˆØ¹)</h3>
        
        <div class="form-grid">
            <div class="form-group">
                <label>Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹</label>
                <input type="text" id="filter-branch" oninput="loadSalesReports()" placeholder="Ù…Ø«Ø§Ù„: ÙØ±Ø¹ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©...">
            </div>
            <div class="form-group">
                <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</label>
                <div id="total-sales-display" style="font-weight:bold; font-size:18px; color:var(--success); padding:5px;">0 Ø¬.Ù…</div>
            </div>
        </div>

<div style="overflow-x:auto; margin-top:15px; border:1px solid #eee; border-radius:8px;">
            <table style="width:100%; border-collapse: collapse; font-size:13px;">
                <thead style="background:#1e293b; color:white;">
                    <tr>
                        <th style="padding:15px; width:25%;">Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹</th>
                        <th style="padding:15px; width:55%;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th>
                        <th style="padding:15px; width:20%;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±Ø¹</th>
                    </tr>
                </thead>
                <tbody id="sales-report-body">
                    <tr><td colspan="3" style="text-align:center; padding:20px;">Ø§Ø¶ØºØ· ØªØ­Ø¯ÙŠØ« Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>
                </tbody>
            </table>
        </div>
 <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="loadSalesReports()" class="btn btn-gray" style="flex:1;">
                <i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
            
            <button onclick="downloadSalesReportExcel()" class="btn" style="background:#217346; color:white; flex:1;">
                <i class="fas fa-file-excel"></i> ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø¥ÙƒØ³ÙŠÙ„
            </button>
        </div>
    </section>
<section id="p-analytics" class="panel">
    <h3 style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:20px;">
        ğŸ“ˆ Ù„ÙˆØ­Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Analytics Dashboard)
    </h3>
    
    <div style="display:flex; justify-content:flex-end; margin-bottom:15px;">
        <button onclick="calculateAnalytics()" class="btn btn-save" style="width:auto;">
            <i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
        </button>
    </div>

    <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        
        <!-- Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹ -->
        <div style="background:white; padding:15px; border-radius:10px; border:1px solid #e2e8f0; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
            <h4 style="text-align:center; color:#1e293b; margin-bottom:15px;">ğŸ† Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹ (Ø¨Ø§Ù„Ù‚ÙŠÙ…Ø©)</h4>
            <canvas id="branchChart"></canvas>
        </div>

        <!-- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ø§Ù‹ -->
        <div style="background:white; padding:15px; border-radius:10px; border:1px solid #e2e8f0; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
            <h4 style="text-align:center; color:#10b981; margin-bottom:15px;">ğŸ”¥ Ø£ÙƒØ«Ø± 5 Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Ù‹</h4>
            <canvas id="topProductsChart"></canvas>
        </div>

        <!-- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£Ù‚Ù„ Ø·Ù„Ø¨Ø§Ù‹ -->
        <div style="background:white; padding:15px; border-radius:10px; border:1px solid #e2e8f0; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
            <h4 style="text-align:center; color:#ef4444; margin-bottom:15px;">ğŸ’¤ Ø£Ù‚Ù„ 5 Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Ù‹</h4>
            <canvas id="lowProductsChart"></canvas>
        </div>
        
         <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø³Ø±ÙŠØ¹Ø© -->
        <div style="background:linear-gradient(135deg, #1a73e8, #0d47a1); color:white; padding:20px; border-radius:10px; display:flex; flex-direction:column; justify-content:center; align-items:center;">
            <div style="font-size:40px;"><i class="fas fa-coins"></i></div>
            <div style="font-size:14px; opacity:0.8;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</div>
            <div id="total-revenue-analytics" style="font-size:24px; font-weight:bold; margin-top:10px;">0 Ø¬.Ù…</div>
        </div>

    </div>
</section>
    <!-- Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
    <section id="p-users" class="panel">
        <h3 style="border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ›¡ï¸ Ø¥Ø¯Ø§Ø±Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
            <div class="form-group" style="background:#e0f2fe; padding:15px; border-radius:8px; border:1px solid #bae6fd; margin-bottom: 20px;">
        <label style="color:#0369a1; font-size:14px;"><i class="fas fa-key"></i> ÙƒÙˆØ¯ Ø¯Ø®ÙˆÙ„ ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø« (Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†)</label>
        <div style="display:flex; gap:10px; margin-top:5px;">
            <input type="text" id="appAccessCode" placeholder="Ù…Ø«Ø§Ù„: 2026" style="flex:2; font-weight:bold; text-align:center; letter-spacing:2px;">
            <button onclick="saveAppAccessCode()" class="btn btn-save" style="flex:1; background:#0284c7;">Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯</button>
        </div>
        <p style="font-size:11px; color:#555; margin-top:5px;">* Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø³ÙŠØ·Ù„Ø¨Ù‡ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø£ÙŠ Ø´Ø®Øµ ÙŠØ­Ø§ÙˆÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø«.</p>
    </div>
        <div class="form-group" style="background:#f8fafc; padding:15px; border-radius:8px; border:1px dashed #cbd5e1;">
            <label style="color:var(--main-blue);">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø³ØªØ®Ø¯Ù…</label>
            <div style="display:flex; gap:10px; margin-top:5px;">
                <input type="email" id="u-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…" style="flex:2;">
                <select id="u-role" style="flex:1;">
                    <option value="admin">Ù…Ø¯ÙŠØ± ÙƒØ§Ù…Ù„ (Admin)</option>
                    <option value="editor">Ù…Ø­Ø±Ø± (Ù…Ù†ØªØ¬Ø§Øª ÙÙ‚Ø·)</option>
                    <option value="viewer">Ù…Ø´Ø§Ù‡Ø¯ (ØªÙ‚Ø§Ø±ÙŠØ± ÙÙ‚Ø·)</option>
                </select>
                <button onclick="saveUserRole()" class="btn btn-save" style="flex:1;">Ø­ÙØ¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</button>
            </div>
            <p style="font-size:11px; color:#666; margin-top:5px;">* Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ÙÙŠ Firebase Auth Ø£ÙˆÙ„Ø§Ù‹ØŒ Ù‡Ù†Ø§ Ù†Ø­Ø¯Ø¯ ØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡ ÙÙ‚Ø·.</p>
        </div>

        <h4 style="margin-top:20px;">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ†</h4>
        <div id="users-list" style="margin-top:10px;"></div>
    </section>
    <!-- Ø§Ù…Ø§Ù† Ø§Ù„Ø­Ø³Ø§Ø¨-->
    <section id="p-security" class="panel">
    <h3 style="margin:0 0 10px 0; font-size:14px; color:var(--main-blue)">ğŸ” Ø£Ù…Ø§Ù† Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
    
    <div style="text-align:center; padding:30px; background:#f8fafc; border-radius:10px; border:1px solid #e2e8f0;">
        <div style="font-size:40px; color:#10b981; margin-bottom:15px;">
            <i class="fas fa-user-shield"></i>
        </div>
        <h3 style="color:#334155; margin:0;">Ø£Ù†Øª Ù…ØªØµÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
        <p id="user-email-display" style="margin:10px 0 20px; color:#64748b; font-weight:bold; font-family:monospace; font-size:14px;"></p>
        
        <button onclick="handleLogout()" class="btn btn-red" style="margin: 0 auto; width: 200px;">
            <i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        </button>
        
        <p style="margin-top:20px; font-size:11px; color:#94a3b8;">
            Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŒ Ø³ØªØ¸Ù‡Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ÙˆÙ„Ù† ÙŠØªÙ…ÙƒÙ† Ø£Ø­Ø¯ Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….
        </p>
    </div>
</section>
<script>
  
// Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„ØªØ±Ø§Ø¬Ø¹
let previousConfigBackup = null;
let currentServerConfig = {};
    // âš ï¸ Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ
    const firebaseConfig = {
  apiKey: "AIzaSyAsjxa0sr72e2PaEMOU9aVapNaCKcD6hUE",
  authDomain: "elaraby-products.firebaseapp.com",
  databaseURL: "https://elaraby-products-default-rtdb.firebaseio.com",
  projectId: "elaraby-products",
  storageBucket: "elaraby-products.firebasestorage.app",
  messagingSenderId: "257061984766",
  appId: "1:257061984766:web:211e2ee759d2957ec248af",
  measurementId: "G-WLLL38KSVT"
};
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const quill = new Quill('#editor-container', { theme: 'snow', modules: { toolbar: [['bold', 'italic', 'underline'], [{ 'color': [] }], ['clean']] } });

    let localProducts = [];
    let currentColors = [];
    let previousConfig = null; // Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ù„Ù„ØªØ±Ø§Ø¬Ø¹)

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    db.collection("products").onSnapshot(snap => {
        localProducts = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        updateDashboardStats();
    });

    db.collection("app_config").doc("ultimate_v5").onSnapshot(doc => {
    if(doc.exists) {
        currentServerConfig = doc.data(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø§ ÙŠÙƒØªØ¨ Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ù†Ø­Ø¯Ø« Ø§Ù„Ø­Ù‚ÙˆÙ„
        if(document.activeElement.tagName !== "INPUT") {
             fillConfigForm(currentServerConfig);
        }
    }
});
    
    // 1. Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
    function toggleAdInputs() {
        const type = document.getElementById('adSourceType').value;
        document.getElementById('input-image-group').style.display = (type === 'image') ? 'block' : 'none';
        document.getElementById('input-code-group').style.display = (type === 'code') ? 'block' : 'none';
    }

    function toggleTimerInput() {
        const pos = document.getElementById('adPosition').value;
        const timerGroup = document.getElementById('timer-group');
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø¤Ù‚Øª ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†ÙˆØ¹ Popup
        if(pos === 'popup') {
            timerGroup.style.opacity = '1'; 
            timerGroup.style.pointerEvents = 'auto';
        } else {
            timerGroup.style.opacity = '0.3'; 
            timerGroup.style.pointerEvents = 'none';
        }
    }

    // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    db.collection("app_config").doc("ads").onSnapshot(doc => {
        if(doc.exists){
            const d = doc.data();
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('adSourceType').value = d.sourceType || 'image';
            document.getElementById('adImg').value = d.img || "";
            document.getElementById('adLink').value = d.link || "";
            document.getElementById('adHtmlCode').value = d.htmlCode || "";
            document.getElementById('adPosition').value = d.position || "popup";
            document.getElementById('adTimer').value = d.timer || 0;
            document.getElementById('adStatus').value = String(d.active);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            toggleAdInputs();
            toggleTimerInput();
        }
    });

    // 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
    async function updateAds() {
        if(!auth.currentUser) return alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
        
        const data = {
            sourceType: document.getElementById('adSourceType').value,
            img: document.getElementById('adImg').value,
            link: document.getElementById('adLink').value,
            htmlCode: document.getElementById('adHtmlCode').value,
            position: document.getElementById('adPosition').value,
            timer: parseInt(document.getElementById('adTimer').value) || 0,
            active: document.getElementById('adStatus').value === "true",
            updatedAt: Date.now()
        };
        
        try {
            await db.collection("app_config").doc("ads").set(data);
            alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­");
        } catch(e) {
            alert("âŒ Ø®Ø·Ø£: " + e.message);
        }
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ---
    function liveSearch(val) {
        const sugBox = document.getElementById("suggestions");
        const mBtn = document.getElementById("mainBtn");
        sugBox.innerHTML = "";
        if(!val) { sugBox.style.display = "none"; return; }
        
        const matches = localProducts.filter(p => p.id.toLowerCase().includes(val.toLowerCase()));
        if(matches.length) {
            sugBox.style.display = "block";
            matches.forEach(p => {
                const div = document.createElement("div");
                div.className = "sug-item";
                div.innerHTML = `<strong>${p.id}</strong> <span>${p.name || ''}</span>`;
                div.onclick = () => fillForm(p);
                sugBox.appendChild(div);
            });
        }
        
        const exist = localProducts.find(p => p.id.toLowerCase() === val.trim().toLowerCase());
        mBtn.innerHTML = exist ? '<i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬' : '<i class="fas fa-plus"></i> Ø­ÙØ¸ Ø¬Ø¯ÙŠØ¯';
        mBtn.className = exist ? "btn btn-update" : "btn btn-save";
    }

    function fillForm(p) {
        document.getElementById("productId").value = p.id;
        document.getElementById("name").value = p.name || "";
        document.getElementById("price").value = p.price || "";
        document.getElementById("p-category").value = p.category || "";
        quill.root.innerHTML = p.details || "";
        document.getElementById("images").value = (p.images || []).join(",");
        document.getElementById("video").value = p.video || "";
        currentColors = p.colors || [];
        syncPreviews(); syncVideo(); syncColors();
        document.getElementById("suggestions").style.display = "none";
        document.getElementById("mainBtn").innerHTML = '<i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬';
        document.getElementById("mainBtn").className = "btn btn-update";
    }

    function clearForm() {
        document.getElementById("productId").value = "";
        document.getElementById("name").value = "";
        document.getElementById("price").value = "";
        document.getElementById("p-category").value = "";
        quill.root.innerHTML = "";
        document.getElementById("images").value = "";
        document.getElementById("video").value = "";
        currentColors = [];
        syncPreviews(); syncVideo(); syncColors();
        document.getElementById("mainBtn").innerHTML = '<i class="fas fa-plus"></i> Ø­ÙØ¸ Ø¬Ø¯ÙŠØ¯';
        document.getElementById("mainBtn").className = "btn btn-save";
    }

    function syncPreviews() {
        const box = document.getElementById("imagePreview");
        box.innerHTML = "";
        const urls = document.getElementById("images").value.split(",");
        urls.forEach((url, i) => {
            if(url.trim()) {
                box.innerHTML += `<div class="preview-card" style="width:60px; height:60px; display:inline-block; margin:2px;"><img src="${url.trim()}"><button class="remove-badge" onclick="popImg(${i})">Ã—</button></div>`;
            }
        });
    }
    function popImg(i) { let arr = document.getElementById("images").value.split(","); arr.splice(i, 1); document.getElementById("images").value = arr.join(","); syncPreviews(); }

    function syncVideo() {
        const v = document.getElementById("video").value.trim();
        const box = document.getElementById("videoPreview");
        box.innerHTML = "";
        if(!v) return;
        if(v.includes("youtube.com") || v.includes("youtu.be")) {
            let id = v.includes("v=") ? v.split("v=")[1].split("&")[0] : v.split("/").pop();
            box.innerHTML = `<div class="preview-card" style="width:100%"><iframe width="100%" height="150" src="https://www.youtube.com/embed/${id}" frameborder="0" allowfullscreen></iframe></div>`;
        } else { box.innerHTML = `<div class="preview-card" style="width:100%"><video width="100%" height="150" controls src="${v}"></video></div>`; }
    }
    
    function addColorItem() {
        const n = document.getElementById("cName").value, c = document.getElementById("cCode").value, i = document.getElementById("cImg").value;
        if(!n) return alert("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù„ÙˆÙ†");
        currentColors.push({ name: n, code: c, image: i }); syncColors();
        document.getElementById("cName").value = ''; document.getElementById("cImg").value = '';
    }
    function syncColors() {
        const box = document.getElementById("colorsPreview"); box.innerHTML = "";
        currentColors.forEach((item, i) => {
            box.innerHTML += `<div class="color-item-card"><div class="color-preview-dot" style="background:${item.code}"></div><span>${item.name}</span><button class="remove-badge" onclick="removeColor(${i})" style="position:static; margin-right:5px;">Ã—</button></div>`;
        });
    }
    function removeColor(index) { currentColors.splice(index, 1); syncColors(); }

async function commitProduct() {
        if(!auth.currentUser) return alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­ÙØ¸");
        const id = document.getElementById("productId").value.trim();
        if(!id) return alert("Ø§Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯");

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³Ù… (Ù†Øµ ÙÙ‚Ø·)
        const rawName = document.getElementById("name").value;
        const cleanName = DOMPurify.sanitize(rawName, {ALLOWED_TAGS: []});

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªÙØ§ØµÙŠÙ„ (HTML Ø¢Ù…Ù†) - ÙŠØ£ØªÙŠ Ù…Ù† Ù…Ø­Ø±Ø± Quill
        const rawDetails = quill.root.innerHTML;
        const cleanDetails = DOMPurify.sanitize(rawDetails);

        const data = {
            name: cleanName,
            price: document.getElementById("price").value,
            category: document.getElementById("p-category").value || "Ø¹Ø§Ù…",
            details: cleanDetails, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ø¸ÙŠÙØ©
            images: document.getElementById("images").value.split(",").map(s => s.trim()).filter(s => s),
            video: document.getElementById("video").value,
            colors: currentColors,
            updatedAt: Date.now()
        };
        
        // ... ØªÙƒÙ…Ù„Ø© Ø§Ù„Ø¯Ø§Ù„Ø© ÙƒÙ…Ø§ Ù‡ÙŠ (batch.set Ø£Ùˆ db.collection...)
        try {
            await db.collection("products").doc(id).set(data, {merge:true});
            await db.collection("app_config").doc("metadata").set({ last_update_time: Date.now() }, {merge:true});
            alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸");
        } catch(e) { alert("âŒ Ø®Ø·Ø£: " + e.message); }
    }
    
    async function removeProduct() {
        if(!auth.currentUser) return alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­Ø°Ù");
        const id = document.getElementById("productId").value.trim();
        if(id && confirm("Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) {
            await db.collection("products").doc(id).delete();
            await db.collection("app_config").doc("metadata").set({ last_update_time: Date.now() }, {merge:true});
            alert("ØªÙ… Ø§Ù„Ø­Ø°Ù"); clearForm();
        }
    }

   // 1. Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
    function toggleAdInputs() {
        const type = document.getElementById('adSourceType').value;
        document.getElementById('input-image-group').style.display = (type === 'image') ? 'block' : 'none';
        document.getElementById('input-code-group').style.display = (type === 'code') ? 'block' : 'none';
    }

    function toggleTimerInput() {
        const pos = document.getElementById('adPosition').value;
        const timerGroup = document.getElementById('timer-group');
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø¤Ù‚Øª ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†ÙˆØ¹ Popup
        if(pos === 'popup') {
            timerGroup.style.opacity = '1'; 
            timerGroup.style.pointerEvents = 'auto';
        } else {
            timerGroup.style.opacity = '0.3'; 
            timerGroup.style.pointerEvents = 'none';
        }
    }

    // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    db.collection("app_config").doc("ads").onSnapshot(doc => {
        if(doc.exists){
            const d = doc.data();
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('adSourceType').value = d.sourceType || 'image';
            document.getElementById('adImg').value = d.img || "";
            document.getElementById('adLink').value = d.link || "";
            document.getElementById('adHtmlCode').value = d.htmlCode || "";
            document.getElementById('adPosition').value = d.position || "popup";
            document.getElementById('adTimer').value = d.timer || 0;
            document.getElementById('adStatus').value = String(d.active);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            toggleAdInputs();
            toggleTimerInput();
        }
    });

    // 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
    async function updateAds() {
        if(!auth.currentUser) return alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
        
        const data = {
            sourceType: document.getElementById('adSourceType').value,
            img: document.getElementById('adImg').value,
            link: document.getElementById('adLink').value,
            htmlCode: document.getElementById('adHtmlCode').value,
            position: document.getElementById('adPosition').value,
            timer: parseInt(document.getElementById('adTimer').value) || 0,
            active: document.getElementById('adStatus').value === "true",
            updatedAt: Date.now()
        };
        
        try {
            await db.collection("app_config").doc("ads").set(data);
            alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­");
        } catch(e) {
            alert("âŒ Ø®Ø·Ø£: " + e.message);
        }
    }
    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø¸Ù‡Ø± ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
    // Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙÙ‚Ø·
async function saveAppearanceData() {
    if(!auth.currentUser) return alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");

    const updates = {
        appFont: document.getElementById('appFont').value,
        detailsColor: document.getElementById('detailsColor').value,
        titleColor: document.getElementById('titleColor').value,
        cardAnim: document.getElementById('cardAnim').value,
        logoEffect: document.getElementById('logoAnimType').value, // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø±ÙƒØ© Ù‡Ù†Ø§ Ø£ÙŠØ¶Ø§Ù‹ ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª
        updatedAt: Date.now()
    };

    // ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ±Ø§Ø¬Ø¹ (Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
    previousConfigBackup = {
        appFont: currentServerConfig.appFont || "Cairo",
        detailsColor: currentServerConfig.detailsColor || "#64748b",
        titleColor: currentServerConfig.titleColor || "#334155",
        cardAnim: currentServerConfig.cardAnim || "fadeInUp",
        logoEffect: currentServerConfig.logoEffect || "none"
    };

    try {
        await db.collection("app_config").doc("ultimate_v5").set(updates, { merge: true });
        alert("âœ¨ ØªÙ… Ø­ÙØ¸ (Ø§Ù„Ø®Ø·ÙˆØ·ØŒ Ø§Ù„Ø£Ù„ÙˆØ§Ù†ØŒ ÙˆØ§Ù„Ø­Ø±ÙƒØ©) Ø¨Ù†Ø¬Ø§Ø­.");
    } catch(e) { alert("âŒ Ø®Ø·Ø£: " + e.message); }
}


async function undoLastChange() {
    if (!previousConfigBackup || Object.keys(previousConfigBackup).length === 0) {
        return alert("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø£Ø®ÙŠØ±Ø© Ù„Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§.");
    }

    if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ© Ø­ÙØ¸ØŸ")) return;

    try {
        // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙÙ‚Ø·
        await db.collection("app_config").doc("ultimate_v5").set(previousConfigBackup, { merge: true });
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹ Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ØªÙŠ ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹Ù‡Ø§
        for (let key in previousConfigBackup) {
            const el = document.getElementById(key === 'logoEffect' ? 'logoAnimType' : key);
            if (el) el.value = previousConfigBackup[key];
        }

        alert("â†©ï¸ ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¨Ù†Ø¬Ø§Ø­!");
        previousConfigBackup = null; 
    } catch (e) { alert("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ±Ø§Ø¬Ø¹: " + e.message); }
}

    async function resetAppearanceToDefault() {
        if(!auth.currentUser) return alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
        if(!confirm("Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ù„ÙˆØ¬Ùˆ Ù„Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;
        
        const defaults = {
            logoUrl: "https://i.top4top.io/p_3662hu6pn1.png",
            titleColor: "#1a73e8",
            cardAnim: "slideInUp",
            fontType: "'Cairo', sans-serif"
        };
        // Ù†Ù‚ÙˆÙ… Ø¨Ø¯Ù…Ø¬ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await db.collection("app_config").doc("ultimate_v5").set(defaults, { merge: true });
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        document.getElementById('logoUrl').value = defaults.logoUrl;
        document.getElementById('titleColor').value = defaults.titleColor;
        document.getElementById('cardAnim').value = defaults.cardAnim;
        alert("âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ");
    }

    async function resetAllConfig() {
        if(!auth.currentUser) return alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
        const code = prompt("Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŒ Ø§ÙƒØªØ¨ 'RESET' ÙÙŠ Ø§Ù„Ø®Ø§Ù†Ø© Ø£Ø¯Ù†Ø§Ù‡:");
        if(code !== "RESET") return;

        // Ø¥Ø¹Ø§Ø¯Ø© ÙƒÙ„ Ø´ÙŠØ¡
        const fullDefaults = {
            logoUrl: "https://i.top4top.io/p_3662hu6pn1.png",
            titleColor: "#1a73e8",
            devName: "Abd elmoneim",
            cardAnim: "slideInUp",
            animSpeed: "0.5"
        };
        await db.collection("app_config").doc("ultimate_v5").set(fullDefaults);
        // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        await db.collection("app_config").doc("ads").set({active: false});
        await db.collection("app_config").doc("notifications").set({active: false});
        
        alert("â˜¢ï¸ ØªÙ… Ø¹Ù…Ù„ Ø¶Ø¨Ø· Ù…ØµÙ†Ø¹ ÙƒØ§Ù…Ù„ Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª");
        location.reload();
    }
// --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­Ù…Ø§ÙŠØ© ---// --- Ù…Ù†Ø·Ù‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯ ---

    // 1. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Gatekeeper)
    auth.onAuthStateChanged(user => {
        const overlay = document.getElementById('login-overlay');
        const emailDisplay = document.getElementById('user-email-display');
        
        if(user) {
            // Ø­Ø§Ù„Ø©: Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            overlay.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
            if(emailDisplay) emailDisplay.innerText = user.email;
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„
            // (Ù‡Ø°Ø§ ÙŠÙ…Ù†Ø¹ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„)
             updateDashboardStats(); 
        } else {
            // Ø­Ø§Ù„Ø©: ØºÙŠØ± Ù…Ø³Ø¬Ù„
            overlay.style.display = 'flex'; // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
        }
    });

    // 2. Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
    async function handlePopupLogin() {
        const email = document.getElementById('popup-email').value;
        const pass = document.getElementById('popup-pass').value;
        const msg = document.getElementById('popup-msg');
        const btn = document.querySelector('#login-overlay .btn');

        if(!email || !pass) {
            msg.innerText = "âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„";
            msg.style.color = "#f59e0b";
            return;
        }

        // ØªØºÙŠÙŠØ± Ù†Øµ Ø§Ù„Ø²Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
        btn.disabled = true;

        try {
            // Firebase ÙŠØ­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Persistence: Local)
            await auth.signInWithEmailAndPassword(email, pass);
            msg.innerText = "âœ… ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­";
            msg.style.color = "#10b981";
            // Ø³ØªØ®ØªÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø³Ø¨Ø¨ auth.onAuthStateChanged
        } catch(e) {
            console.error(e);
            let errorText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
            if(e.code === 'auth/wrong-password') errorText = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
            if(e.code === 'auth/user-not-found') errorText = "Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± Ù…Ø³Ø¬Ù„";
            
            msg.innerText = "âŒ " + errorText;
            msg.style.color = "#ef4444";
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø²Ø± Ù„Ø­Ø§Ù„ØªÙ‡
            btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†';
            btn.disabled = false;
        }
    }

    // 3. Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    async function handleLogout() {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
            try {
                await auth.signOut();
                // Ø³ÙŠØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                location.reload(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
            } catch(e) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø®Ø±ÙˆØ¬");
            }
        }
    }
    
    // Ø¯Ø¹Ù… Ø¶ØºØ· Ø²Ø± Enter ÙÙŠ Ø­Ù‚ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    document.getElementById('popup-pass').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') handlePopupLogin();
    });

    function updateDashboardStats() {
        document.getElementById('count-total').innerText = localProducts.length;
        const cats = [...new Set(localProducts.map(p => p.category))];
        document.getElementById('count-cats').innerText = cats.length;
        document.getElementById('count-no-img').innerText = localProducts.filter(p => !p.images || p.images.length === 0).length;
    }

    function showPanel(id, btn) {
        document.querySelectorAll('.panel, .nav-link').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active'); btn.classList.add('active');
    }
	// Ø¯Ø§Ù„Ø© Ù„ØªØµÙÙŠØ© ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØµÙˆØ±
function filterNoImageProducts() {
    const sugBox = document.getElementById("suggestions");
    const productIdInput = document.getElementById("productId");
    
    // 1. ØªØµÙÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙŠ Ù…ØµÙÙˆÙØ© ØµÙˆØ±Ù‡Ø§ ÙØ§Ø±ØºØ© Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©
    const missingImages = localProducts.filter(p => !p.images || p.images.length === 0 || (p.images.length === 1 && p.images[0] === ""));

    if (missingImages.length === 0) {
        alert("ğŸ‰ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØµÙˆØ± Ø­Ø§Ù„ÙŠØ§Ù‹!");
        return;
    }

    // 2. Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø®ÙÙŠØ©
    showPanel('p-products', document.querySelector('[onclick*="p-products"]'));

    // 3. Ù…Ø³Ø­ ÙˆØªØ¬Ù‡ÙŠØ² ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    sugBox.innerHTML = `<div style="padding:10px; background:#fffbeb; font-weight:bold; border-bottom:1px solid #f59e0b; font-size:11px; color:#b45309;">âš ï¸ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ (${missingImages.length}) Ù…Ù†ØªØ¬ Ø¨Ø¯ÙˆÙ† ØµÙˆØ±:</div>`;
    sugBox.style.display = "block";

    // 4. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    missingImages.forEach(p => {
        const div = document.createElement("div");
        div.className = "sug-item";
        div.innerHTML = `<strong>${p.id}</strong> <span>${p.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</span> <i class="fas fa-edit" style="color:#64748b"></i>`;
        div.onclick = () => {
            fillForm(p);
            sugBox.style.display = "none";
        };
        sugBox.appendChild(div);
    });

    // 5. Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¨ØµØ±ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    productIdInput.placeholder = "ØªØµÙÙŠØ©: Ø¨Ø¯ÙˆÙ† ØµÙˆØ±...";
    productIdInput.focus();
}
// --- 1. Ø¯Ø§Ù„Ø© Ø­ÙØ¸ ØµÙˆØ±Ø© ÙˆØ­Ø±ÙƒØ© Ø§Ù„Ù„ÙˆØ¬Ùˆ ÙÙ‚Ø· ---
// Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ù„ÙˆØ¬Ùˆ (Ø§Ù„Ø±Ø§Ø¨Ø· + Ø§Ù„Ø­Ø±ÙƒØ©)
async function saveLogoData() {
    if(!auth.currentUser) return alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");

    const updates = {
        logoUrl: document.getElementById('logoUrl').value,
        logoEffect: document.getElementById('logoAnimType').value,
        updatedAt: Date.now()
    };

    // ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
    previousConfigBackup = {
        logoUrl: currentServerConfig.logoUrl || "",
        logoEffect: currentServerConfig.logoEffect || "none"
    };

    try {
        await db.collection("app_config").doc("ultimate_v5").set(updates, { merge: true });
        alert("âœ… ØªÙ… Ø­ÙØ¸ Ø±Ø§Ø¨Ø· Ø§Ù„Ù„ÙˆØ¬Ùˆ ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­.");
    } catch(e) { alert("âŒ Ø®Ø·Ø£: " + e.message); }
}

// --- 2. Ø¯ÙˆØ§Ù„ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø© ---
// Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
db.collection("app_config").doc("maintenance_mode").onSnapshot(doc => {
    if(doc.exists) {
        const d = doc.data();
        document.getElementById('maintStatus').value = d.isActive ? "true" : "false";
        document.getElementById('maintMsg').value = d.message || "";
    }
});

// Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©
async function updateMaintenance() {
    if(!auth.currentUser) return alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
    
    const isActive = document.getElementById('maintStatus').value === "true";
    const message = document.getElementById('maintMsg').value;
    
    try {
        await db.collection("app_config").doc("maintenance_mode").set({
            isActive: isActive,
            message: message,
            updatedAt: Date.now()
        });
        
        alert(isActive ? "â›” ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©" : "âœ… ØªÙ… ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ø²ÙˆØ§Ø±");
    } catch(e) {
        alert("âŒ Ø®Ø·Ø£: " + e.message);
    }
}
// Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø·ÙˆØ± ÙˆØ±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ÙÙ‚Ø·
async function saveDevInfoOnly() {
    if(!auth.currentUser) return alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");

    // Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„
    const name = document.getElementById('devName').value;
    const phone = document.getElementById('devPhone').value;

    // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ­Ø¯ÙŠØ«Ù‡Ø§ ÙÙ‚Ø·
    const devData = {
        devName: name,
        devPhone: phone,
        updatedAt: Date.now() // Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«
    };

    try {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… merge: true Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ù…Ø³Ø­ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø£Ùˆ Ø§Ù„Ù„ÙˆØ¬Ùˆ Ø£Ùˆ Ø£ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø®Ø±Ù‰
        await db.collection("app_config").doc("ultimate_v5").set(devData, { merge: true });
        
        // ØªØ­Ø¯ÙŠØ« Ù†Ø³Ø®Ø© Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ù„ØªØ¹ÙˆØ¯ Ù„Ù„Ù‚ÙŠÙ… Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ÙŠÙ† ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
        previousConfigBackup = {
            devName: currentServerConfig.devName || "",
            devPhone: currentServerConfig.devPhone || ""
        };

        alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ± (Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù…) Ø¨Ù†Ø¬Ø§Ø­!");
    } catch (e) {
        console.error("Error saving dev info:", e);
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: " + e.message);
    }
}
// Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø£Ù„ÙˆØ§Ù† Ø²Ø± Ø§Ù„Ø¨Ø­Ø« ÙÙ‚Ø·
async function saveSearchBtnColorsOnly() {
    if(!auth.currentUser) return alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");

    // Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const btnBg = document.getElementById('searchBtnBg').value;
    const btnColor = document.getElementById('searchBtnColor').value;

    // ØªØ¬Ù‡ÙŠØ² ÙƒØ§Ø¦Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù†ÙŠØ© ÙÙ‚Ø·
    const colorData = {
        searchBtnBg: btnBg,
        searchBtnColor: btnColor,
        updatedAt: Date.now()
    };

    try {
        // Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø®Ø§ØµÙŠØ© Ø§Ù„Ø¯Ù…Ø¬
        await db.collection("app_config").doc("ultimate_v5").set(colorData, { merge: true });
        
        // ØªØ­Ø¯ÙŠØ« Ø°Ø§ÙƒØ±Ø© Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙ‚Ø·
        previousConfigBackup = {
            searchBtnBg: currentServerConfig.searchBtnBg || "#1a73e8",
            searchBtnColor: currentServerConfig.searchBtnColor || "#ffffff"
        };

        alert("ğŸ¨ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø£Ù„ÙˆØ§Ù† Ø²Ø± Ø§Ù„Ø¨Ø­Ø« Ø¨Ù†Ø¬Ø§Ø­!");
    } catch (e) {
        console.error("Error saving search button colors:", e);
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: " + e.message);
    }
}
// Ø¯Ø§Ù„Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„ÙƒÙ„ Ù‚Ø³Ù…
async function resetToDefault(type) {
    if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…ØŸ")) return;

    let defaults = {};
    
    // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„ÙƒÙ„ Ù†ÙˆØ¹
    switch(type) {
        case 'dev':
            defaults = {
                devName: "Ø§Ø³Ù… Ø§Ù„Ù…Ø·ÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ",
                devPhone: "201000000000"
            };
            break;
        case 'searchBtn':
            defaults = {
                searchBtnBg: "#1a73e8", // Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                searchBtnColor: "#ffffff" // Ø§Ù„Ø£Ø¨ÙŠØ¶ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
            };
            break;
        case 'logo':
            defaults = {
                logoEffect: "none" // Ø¨Ø¯ÙˆÙ† Ø­Ø±ÙƒØ©
            };
            break;
        case 'appearance': // Ù„Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¹Ø§Ù… Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
            defaults = {
                titleColor: "#334155",
                detailsColor: "#64748b",
                appFont: "Cairo",
                cardAnim: "fadeInUp"
            };
            break;
    }

    try {
        // 1. ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        await db.collection("app_config").doc("ultimate_v5").set(defaults, { merge: true });
        
        // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø£Ù…Ø§Ù…Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©
        for (let key in defaults) {
            const input = document.getElementById(key === 'logoEffect' ? 'logoAnimType' : key);
            if (input) input.value = defaults[key];
        }

        alert("âª ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙˆØ­ÙØ¸Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­.");
    } catch (e) {
        alert("âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©: " + e.message);
    }
}
// Ø¯Ø§Ù„Ø© Ù…Ø®ØµØµØ© Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¸Ù‡Ø± ÙˆØ§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ø­Ø±ÙƒØ© Ù„Ù„Ù‚ÙŠÙ… Ø§Ù„Ø£ØµÙ„ÙŠØ©
async function resetAppearanceToDefault() {
    if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ø­Ø±ÙƒØ© Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØŸ")) return;

    // 1. ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„Ù‚Ø§Ù„Ø¨
    const appearanceDefaults = {
        appFont: "Cairo",           // Ø§Ù„Ø®Ø· Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        titleColor: "#334155",      // Ù„ÙˆÙ† Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† (Ø±Ù…Ø§Ø¯ÙŠ ØºØ§Ù…Ù‚)
        detailsColor: "#64748b",    // Ù„ÙˆÙ† Ø§Ù„ØªÙØ§ØµÙŠÙ„ (Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­)
        cardAnim: "fadeInUp",       // Ø­Ø±ÙƒØ© Ø§Ù„ÙƒØ±ÙˆØª
        logoEffect: "none"          // Ø­Ø±ÙƒØ© Ø§Ù„Ù„ÙˆØ¬Ùˆ
    };

    try {
        // 2. ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙˆØ±Ø§Ù‹ (Ø§Ø³ØªØ®Ø¯Ø§Ù… merge Ù„Ø¹Ø¯Ù… Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ± Ø£Ùˆ Ø§Ù„ØµÙŠØ§Ù†Ø©)
        await db.collection("app_config").doc("ultimate_v5").set(appearanceDefaults, { merge: true });

        // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø£Ù…Ø§Ù…Ùƒ
        document.getElementById('appFont').value = appearanceDefaults.appFont;
        document.getElementById('titleColor').value = appearanceDefaults.titleColor;
        document.getElementById('detailsColor').value = appearanceDefaults.detailsColor;
        document.getElementById('cardAnim').value = appearanceDefaults.cardAnim;
        document.getElementById('logoAnimType').value = appearanceDefaults.logoEffect; // ØªØ£ÙƒØ¯ Ø£Ù† ID Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø±ÙƒØ© Ù‡Ùˆ logoAnimType

        alert("âª ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ø­Ø±ÙƒØ© Ù„Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­.");
    } catch (e) {
        console.error("Reset Error:", e);
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©: " + e.message);
    }
}
// --- ÙˆØ¸Ø§Ø¦Ù Ø£ÙƒÙˆØ§Ø¯ Ø¨Ø§Ù†Ø¯Ù„ ---
    // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ÙˆØ¹Ø±Ø¶Ù‡Ø§
    db.collection("bundle_codes").orderBy("createdAt", "desc").onSnapshot(snap => {
        const list = document.getElementById("bundles-list");
        if(list) {
            list.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                list.innerHTML += `
                <div style="background:white; padding:10px; border-radius:8px; border:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold; color:#1e293b;">${d.name}</div>
                        <div style="font-size:11px; color:#64748b;">${d.desc}</div>
                        <div style="background:#eff6ff; color:#1d4ed8; padding:2px 8px; border-radius:4px; display:inline-block; margin-top:4px; font-family:monospace; font-weight:bold;">${d.code}</div>
                    </div>
                    <button onclick="deleteBundle('${doc.id}')" class="btn btn-red" style="width:auto; padding:5px 10px;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>`;
            });
        }
    });

    // 2. Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯
    async function addBundle() {
        if(!auth.currentUser) return alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
        const name = document.getElementById('bundleName').value;
        const code = document.getElementById('bundleCode').value;
        const desc = document.getElementById('bundleDesc').value;

        if(!name || !code) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ÙƒÙˆØ¯");

        try {
            await db.collection("bundle_codes").add({
                name, code, desc, createdAt: Date.now()
            });
            document.getElementById('bundleName').value = "";
            document.getElementById('bundleCode').value = "";
            document.getElementById('bundleDesc').value = "";
            alert("âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„ÙƒÙˆØ¯");
        } catch(e) { alert("Error: " + e.message); }
    }

    // 3. Ø­Ø°Ù ÙƒÙˆØ¯
    async function deleteBundle(id) {
        if(confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ØŸ")) {
            await db.collection("bundle_codes").doc(id).delete();
        }
    }
    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„ (Excel Handler) ---

    // 1. ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ ÙØ§Ø±Øº Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ¹Ø±Ù Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
    function downloadTemplate() {
        const wb = XLSX.utils.book_new();
        // Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        const ws_data = [
            ["name", "code", "desc"], 
            ["Ø¹Ø±Ø¶ Ø«Ù„Ø§Ø¬Ø© Ø´Ø§Ø±Ø¨", "SHARP10", "Ø®ØµÙ… 10% Ù„ÙØªØ±Ø© Ù…Ø­Ø¯ÙˆØ¯Ø©"],
            ["ØºØ³Ø§Ù„Ø© ØªÙˆØ±Ù†ÙŠØ¯Ùˆ", "TOR2026", "Ø´Ø­Ù† Ù…Ø¬Ø§Ù†ÙŠ"]
        ];
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, "Bundles");
        XLSX.writeFile(wb, "Bundle_Template.xlsx");
    }
// --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„ (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø·ÙˆØ± ÙˆØ§Ù„Ù…ØµØ­Ø­Ø©) ---

    // 1. ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ ÙØ§Ø±Øº
    function downloadTemplate() {
        const wb = XLSX.utils.book_new();
        const ws_data = [
            ["name", "code", "desc"], 
            ["Ø¹Ø±Ø¶ Ø«Ù„Ø§Ø¬Ø© Ø´Ø§Ø±Ø¨", "SHARP10", "Ø®ØµÙ… 10%"],
            ["ØºØ³Ø§Ù„Ø© ØªÙˆØ±Ù†ÙŠØ¯Ùˆ", "TOR2026", "Ø´Ø­Ù† Ù…Ø¬Ø§Ù†ÙŠ"]
        ];
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        XLSX.writeFile(wb, "Bundle_Template.xlsx");
    }

    // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙˆØ¹ (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø¨Ø­Ø« ÙÙŠ ÙƒÙ„ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚)
    function handleExcelUpload(input) {
        const file = input.files[0];
        if (!file) return;

        const statusDiv = document.getElementById('upload-status');
        statusDiv.style.display = 'block';
        statusDiv.style.color = 'orange';
        statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù...';

        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                let foundData = [];
                
                // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„ (Sheets) ÙˆÙ„ÙŠØ³ Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙ‚Ø·
                for (let i = 0; i < workbook.SheetNames.length; i++) {
                    const sheetName = workbook.SheetNames[i];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, {defval: ""}); // Ù‚Ø±Ø§Ø¡Ø© ÙƒÙ„ Ø´ÙŠØ¡
                    
                    if (json.length > 0) {
                        foundData = json;
                        console.log(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙˆØ±Ù‚Ø©: ${sheetName}`);
                        break; // ØªÙˆÙ‚Ù Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª
                    }
                }

                if (foundData.length === 0) {
                    alert("âš ï¸ Ø§Ù„Ù…Ù„Ù ÙŠØ¨Ø¯Ùˆ ÙØ§Ø±ØºØ§Ù‹ ØªÙ…Ø§Ù…Ø§Ù‹! ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ù‚Ø¨Ù„ Ø§Ù„Ø±ÙØ¹.");
                    statusDiv.style.display = 'none';
                    return;
                }

                // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© (Ø§Ø¶ØºØ· F12 Ù„Ø±Ø¤ÙŠØªÙ‡Ø§)
                console.log("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©:", foundData);

                // Ø§Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ù„Ø±ÙØ¹
                uploadBulkBundles(foundData);

            } catch (err) {
                console.error(err);
                alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: " + err.message);
                statusDiv.style.display = 'none';
            }
        };

        reader.readAsArrayBuffer(file);
        input.value = "";
    }

    // 3. Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ØªØ¬Ø§Ù‡Ù„ Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø­Ø±Ù ÙˆØ§Ù„Ù…Ø³Ø§ÙØ§Øª)
    async function uploadBulkBundles(data) {
        if(!auth.currentUser) return alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
        
        const statusDiv = document.getElementById('upload-status');
        statusDiv.innerHTML = `Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© ${data.length} ØµÙ...`;

        const batch = db.batch();
        let count = 0;

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ (ØªØ­ÙˆÙŠÙ„ Ù„ØµØºÙŠØ± ÙˆØ¥Ø²Ø§Ù„Ø© Ù…Ø³Ø§ÙØ§Øª)
        function normalizeKeys(obj) {
            const newObj = {};
            Object.keys(obj).forEach(key => {
                const cleanKey = key.toString().trim().toLowerCase();
                newObj[cleanKey] = obj[key];
            });
            return newObj;
        }

        data.forEach((rawItem) => {
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØµÙ Ø§Ù„Ø­Ø§Ù„ÙŠ
            const item = normalizeKeys(rawItem);

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù…Ø±ÙˆÙ†Ø© Ø¹Ø§Ù„ÙŠØ©
            // ÙŠØ¯Ø¹Ù…: name, Name, NAME, Ø§Ù„Ø§Ø³Ù…, Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶
            const name = item['name'] || item['Ø§Ù„Ø§Ø³Ù…'] || item['Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶'] || item['product'] || item['offer'];
            // ÙŠØ¯Ø¹Ù…: code, Code, CODE, Ø§Ù„ÙƒÙˆØ¯, ÙƒÙˆØ¯
            const code = item['code'] || item['Ø§Ù„ÙƒÙˆØ¯'] || item['ÙƒÙˆØ¯'];
            // ÙŠØ¯Ø¹Ù…: desc, description, details, Ø§Ù„ØªÙØ§ØµÙŠÙ„, Ù…Ù„Ø§Ø­Ø¸Ø§Øª
            const desc = item['desc'] || item['description'] || item['details'] || item['Ø§Ù„ØªÙØ§ØµÙŠÙ„'] || item['Ù…Ù„Ø§Ø­Ø¸Ø§Øª'] || "";

            if (name && code) {
                const docRef = db.collection("bundle_codes").doc(); 
                batch.set(docRef, {
                    name: String(name).trim(),
                    code: String(code).trim(),
                    desc: String(desc).trim(),
                    createdAt: Date.now()
                });
                count++;
            }
        });

        if (count === 0) {
            alert("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø¹Ù…Ø¯Ø© (Name, Code) Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.\n\nØªØ£ÙƒØ¯ Ø£Ù† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø£ÙˆÙ„ ØµÙ Ø¨Ø§Ù„Ù…Ù„Ù Ù‡ÙŠ:\nname , code");
            statusDiv.style.display = 'none';
            return;
        }

        try {
            await batch.commit();
            statusDiv.style.color = 'green';
            statusDiv.innerHTML = `âœ… ØªÙ… Ø±ÙØ¹ ${count} ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­!`;
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ù„Ø¨ ØªØ¹Ù…Ù„ Ø¨Ù†Ø¸Ø§Ù… realtime Ø³ØªØªØ­Ø¯Ø« ÙˆØ­Ø¯Ù‡Ø§)
            setTimeout(() => { statusDiv.style.display = 'none'; }, 4000);
        } catch (error) {
            alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + error.message);
            statusDiv.style.display = 'none';
        }
    }
    // ==========================================
    // ğŸ“¦ Ø¯ÙˆØ§Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„ (Products Excel)
    // ==========================================

    // 1. ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    function downloadProductTemplate() {
        const wb = XLSX.utils.book_new();
        
        // Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        const headers = ["id", "name", "price", "category", "details", "images", "video", "colors"];
        
        // ØµÙ Ù…Ø«Ø§Ù„ ØªÙˆØ¶ÙŠØ­ÙŠ
        const example = [
            "SHARP-REF-100",           // Ø§Ù„ÙƒÙˆØ¯ (id)
            "Ø«Ù„Ø§Ø¬Ø© Ø´Ø§Ø±Ø¨ 18 Ù‚Ø¯Ù…",       // Ø§Ù„Ø§Ø³Ù…
            "25000",                   // Ø§Ù„Ø³Ø¹Ø±
            "Ø«Ù„Ø§Ø¬Ø§Øª",                  // Ø§Ù„Ù‚Ø³Ù…
            "<h3>Ù…ÙˆØ§ØµÙØ§Øª Ù…Ù…ØªØ§Ø²Ø©</h3>", // Ø§Ù„ØªÙØ§ØµÙŠÙ„ (ÙŠÙ…ÙƒÙ† html)
            "link1.jpg, link2.jpg",    // Ø§Ù„ØµÙˆØ± (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©)
            "https://youtu.be/...",    // Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            '[{"name":"Red","code":"#ff0000"}]' // Ø§Ù„Ø£Ù„ÙˆØ§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - ØµÙŠØºØ© JSON)
        ];

        const ws_data = [headers, example];
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, "Products");
        XLSX.writeFile(wb, "Products_Template.xlsx");
    }

    // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    function handleProductExcel(input) {
        const file = input.files[0];
        if (!file) return;

        const statusDiv = document.getElementById('prod-upload-status');
        statusDiv.style.display = 'block';
        statusDiv.style.color = 'orange';
        statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...';

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                let foundData = [];

                // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª
                for (let i = 0; i < workbook.SheetNames.length; i++) {
                    const sheet = workbook.Sheets[workbook.SheetNames[i]];
                    const json = XLSX.utils.sheet_to_json(sheet, {defval: ""});
                    if (json.length > 0) { foundData = json; break; }
                }

                if (foundData.length === 0) {
                    alert("âš ï¸ Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº!");
                    statusDiv.style.display = 'none';
                    return;
                }
                
                uploadBulkProducts(foundData);

            } catch (err) {
                console.error(err);
                alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: " + err.message);
                statusDiv.style.display = 'none';
            }
        };
        reader.readAsArrayBuffer(file);
        input.value = "";
    }

    // 3. Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¥Ù„Ù‰ Firebase
async function uploadBulkProducts(data) {
    if(!auth.currentUser) return alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
    
    const statusDiv = document.getElementById('prod-upload-status');
    statusDiv.innerHTML = `Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ${data.length} Ù…Ù†ØªØ¬...`;

    const chunkSize = 400; 
    const chunks = [];
    for (let i = 0; i < data.length; i += chunkSize) {
        chunks.push(data.slice(i, i + chunkSize));
    }

    let totalUploaded = 0;

    // Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙØ§ØªÙŠØ­
    function normalizeProductKeys(obj) {
        const newObj = {};
        Object.keys(obj).forEach(key => newObj[key.toString().trim().toLowerCase()] = obj[key]);
        return newObj;
    }

    try {
        for (const chunk of chunks) {
            const batch = db.batch();
            
            chunk.forEach((rawItem) => {
                const item = normalizeProductKeys(rawItem);
                
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¹Ø±Ù ÙˆØ§Ù„Ø§Ø³Ù…
                const id = String(item['id'] || item['code'] || item['Ø§Ù„ÙƒÙˆØ¯'] || item['ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬'] || "").trim();
                let rawName = item['name'] || item['Ø§Ù„Ø§Ø³Ù…'] || item['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬'] || "";
                
                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„
                const cleanName = DOMPurify.sanitize(String(rawName), {ALLOWED_TAGS: []});
                let rawDetails = item['details'] || item['Ø§Ù„ØªÙØ§ØµÙŠÙ„'] || item['Ø§Ù„ÙˆØµÙ'] || "";
                const cleanDetails = DOMPurify.sanitize(String(rawDetails));

                // --- (ØªØµØ­ÙŠØ­ Ø§Ù„Ø®Ø·Ø£) Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† ---
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØµÙˆØ± Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙØµÙˆÙ„ Ø¨ÙØ§ØµÙ„Ø©
                let rawImages = item['images'] || item['ØµÙˆØ±'] || item['Ø§Ù„ØµÙˆØ±'] || "";
                let imagesArr = [];
                if(String(rawImages).trim()) {
                    imagesArr = String(rawImages).split(',').map(s => s.trim()).filter(s => s);
                }

                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ù„ÙˆØ§Ù† (Ù†ÙØªØ±Ø¶ Ø£Ù†Ù‡Ø§ JSON Ø£Ùˆ Ù†Øµ Ø¨Ø³ÙŠØ·)
                let rawColors = item['colors'] || item['Ø§Ù„ÙˆØ§Ù†'] || item['Ø§Ù„Ø£Ù„ÙˆØ§Ù†'] || "[]";
                let colorsArr = [];
                try {
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© JSON
                    colorsArr = JSON.parse(rawColors);
                } catch(e) {
                    // Ø¥Ø°Ø§ ÙØ´Ù„ØŒ Ù†Ø¹ØªØ¨Ø±Ù‡Ø§ Ù†ØµØ§Ù‹ ÙˆÙ†Ø­Ø§ÙˆÙ„ ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù‡ÙŠÙƒÙ„ Ø¨Ø³ÙŠØ· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                    console.warn("ØµÙŠØºØ© Ø§Ù„Ø£Ù„ÙˆØ§Ù† ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ù„Ù„Ù…Ù†ØªØ¬: " + id);
                    colorsArr = []; 
                }
                // -------------------------------------------

                if (id && cleanName) {
                    const docRef = db.collection("products").doc(id);
                    
                    const productData = {
                        name: cleanName,
                        price: String(item['price'] || item['Ø§Ù„Ø³Ø¹Ø±'] || ""),
                        category: String(item['category'] || item['Ø§Ù„Ù‚Ø³Ù…'] || "Ø¹Ø§Ù…"),
                        details: cleanDetails,
                        images: imagesArr, // Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¢Ù† Ù…Ø¹Ø±Ù
                        video: String(item['video'] || item['Ø§Ù„ÙÙŠØ¯ÙŠÙˆ'] || ""),
                        colors: colorsArr, // Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¢Ù† Ù…Ø¹Ø±Ù
                        updatedAt: Date.now()
                    };

                    batch.set(docRef, productData, {merge: true});
                    totalUploaded++;
                }
            });

            await batch.commit();
        }

        await db.collection("app_config").doc("metadata").set({ last_update_time: Date.now() }, {merge:true});
        
        statusDiv.style.color = 'green';
        statusDiv.innerHTML = `âœ… ØªÙ… Ø±ÙØ¹/ØªØ­Ø¯ÙŠØ« ${totalUploaded} Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!`;
        setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);

    } catch (error) {
        console.error(error);
        statusDiv.style.color = 'red';
        statusDiv.innerHTML = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹: " + error.message;
    }
}

    // 4. Ø¯Ø§Ù„Ø© ØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª
    function downloadProductsBackup() {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø­Ù…Ù„Ø©
        if (!localProducts || localProducts.length === 0) {
            return alert("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ø£Ùˆ ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹.");
        }

        if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù€ ${localProducts.length} Ù…Ù†ØªØ¬ØŸ`)) return;

        // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªÙ†Ø§Ø³Ø¨ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„
        // Ù†Ù‚ÙˆÙ… Ø¨ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…ØµÙÙˆÙØ§Øª (Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù†) Ø¥Ù„Ù‰ Ù†ØµÙˆØµ Ù„ÙŠÙ…ÙƒÙ† ØªØ®Ø²ÙŠÙ†Ù‡Ø§ ÙÙŠ Ø®Ù„ÙŠØ© ÙˆØ§Ø­Ø¯Ø©
        const backupData = localProducts.map(p => {
            return {
                id: p.id,
                name: p.name,
                price: p.price,
                category: p.category,
                details: p.details, // Ø³ÙŠØ­ØªÙØ¸ Ø¨ÙƒÙˆØ¯ HTML
                // ØªØ­ÙˆÙŠÙ„ Ù…ØµÙÙˆÙØ© Ø§Ù„ØµÙˆØ± Ù„Ù†Øµ Ù…ÙØµÙˆÙ„ Ø¨ÙØ§ØµÙ„Ø©
                images: (p.images || []).join(','), 
                video: p.video,
                // ØªØ­ÙˆÙŠÙ„ ÙƒØ§Ø¦Ù† Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù„Ù†Øµ JSON Ù„ÙŠØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø¹Ù†Ø¯ Ø§Ù„Ø±ÙØ¹
                colors: JSON.stringify(p.colors || []) 
            };
        });

        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(backupData);
        
        // ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ØªÙƒÙˆÙ† Ù…Ù‚Ø±ÙˆØ¡Ø©
        const wscols = [
            {wch: 15}, // id
            {wch: 30}, // name
            {wch: 10}, // price
            {wch: 15}, // category
            {wch: 20}, // details
            {wch: 30}, // images
            {wch: 20}, // video
            {wch: 20}  // colors
        ];
        ws['!cols'] = wscols;

        XLSX.utils.book_append_sheet(wb, ws, "Backup_Products");
        
        // ØªØ³Ù…ÙŠØ© Ø§Ù„Ù…Ù„Ù Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ
        const dateStr = new Date().toISOString().slice(0,10);
        XLSX.writeFile(wb, `Elaraby_Products_Backup_${dateStr}.xlsx`);
    }
// â˜ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Cloudinary (ÙŠØ¬Ø¨ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§)// ==========================================
// â˜ï¸ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹ Ø¹Ù„Ù‰ Cloudinary
// ==========================================
async function uploadImageToCloudinary(input) {
    const file = input.files[0];
    if (!file) return;

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ
    const cloudName = "dkuow8vxw"; 
    const uploadPreset = "elaraby_broducts"; 
    const uploadUrl = `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`;

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const statusDiv = document.getElementById("cl-upload-status");
    const textArea = document.getElementById("images");

    // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹"
    statusDiv.style.display = "block";
    statusDiv.style.color = "#e91e63"; // Ù„ÙˆÙ† ÙˆØ±Ø¯ÙŠ
    statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...';

    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", uploadPreset);

    try {
        const response = await fetch(uploadUrl, {
            method: "POST",
            body: formData
        });

        const data = await response.json();

        if (data.secure_url) {
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ù…Ø±Ø¨Ø¹ (Ù…Ø¹ ÙˆØ¶Ø¹ ÙØ§ØµÙ„Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØµÙˆØ± Ø³Ø§Ø¨Ù‚Ø©)
            const currentText = textArea.value.trim();
            if (currentText.length > 0) {
                textArea.value = currentText + "," + data.secure_url;
            } else {
                textArea.value = data.secure_url;
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙˆØ±Ø§Ù‹
            syncPreviews();

            // Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
            statusDiv.style.color = "green";
            statusDiv.innerHTML = 'âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!';
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
            setTimeout(() => { statusDiv.style.display = "none"; }, 3000);
        } else {
            throw new Error(data.error ? data.error.message : "ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹");
        }

    } catch (error) {
        console.error("Upload Error:", error);
        statusDiv.style.color = "red";
        statusDiv.innerHTML = 'âŒ Ø®Ø·Ø£: ' + error.message;
    } finally {
        // ØªÙØ±ÙŠØº Ù…Ù„Ù Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø±ÙØ¹ Ù†ÙØ³ Ø§Ù„Ù…Ù„Ù Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
        input.value = "";
    }
}
// ==========================================
// â˜ï¸ Ø¯Ø§Ù„Ø© Ø±ÙØ¹ ØµÙˆØ±Ø© Ù„ÙˆÙ† Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
// ==========================================
async function uploadColorImage(input) {
    const file = input.files[0];
    if (!file) return;

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ (Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)
    const cloudName = "dkuow8vxw"; 
    const uploadPreset = "elaraby_broducts"; 
    const uploadUrl = `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`;

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const statusDiv = document.getElementById("color-upload-status");
    const urlInput = document.getElementById("cImg");

    // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹"
    statusDiv.style.display = "block";
    statusDiv.style.color = "#e91e63"; 
    statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ù„ÙˆÙ†...';

    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", uploadPreset);

    try {
        const response = await fetch(uploadUrl, {
            method: "POST",
            body: formData
        });

        const data = await response.json();

        if (data.secure_url) {
            // ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø­Ù‚Ù„ ØµÙˆØ±Ø© Ø§Ù„Ù„ÙˆÙ†
            urlInput.value = data.secure_url;

            // Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
            statusDiv.style.color = "green";
            statusDiv.innerHTML = 'âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹! Ø§Ø¶ØºØ· "Ø¥Ø¶Ø§ÙØ©" Ù„Ø­ÙØ¸ Ø§Ù„Ù„ÙˆÙ†.';
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
            setTimeout(() => { statusDiv.style.display = "none"; }, 3000);
        } else {
            throw new Error(data.error ? data.error.message : "ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹");
        }

    } catch (error) {
        console.error("Color Upload Error:", error);
        statusDiv.style.color = "red";
        statusDiv.innerHTML = 'âŒ Ø®Ø·Ø£: ' + error.message;
    } finally {
        input.value = ""; // ØªÙØ±ÙŠØº Ø§Ù„Ù…Ù„Ù Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø±ÙØ¹ Ø¢Ø®Ø±
    }
}
    // ğŸ›¡ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø«
    // ===================
    
    // Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    let currentUserRole = null;

    // --- Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¯ÙŠØ± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ (Ø£ÙˆÙ„ Ø¯Ø®ÙˆÙ„ ÙŠØµØ¨Ø­ Ù…Ø¯ÙŠØ± Ø¥Ø°Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯ÙŠØ±) ---
    async function ensureAdminExists(userEmail) {
        try {
            const q = await db.collection('app_users').where('role', '==', 'admin').limit(1).get();
            if (q.empty) {
                // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯ÙŠØ± Ù…Ø³Ø¬Ù„ Ø¨Ø¹Ø¯ -> Ø§Ø¬Ø¹Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¯ÙŠØ±Ø§Ù‹
                await db.collection('app_users').doc(userEmail).set({
                    email: userEmail,
                    role: 'admin',
                    createdAt: Date.now(),
                    createdByAuto: true
                });
                console.info("auto-created admin:", userEmail);
            }
        } catch (e) {
            console.error("ensureAdminExists error:", e);
        }
    }

    // ØªØ¹Ø¯ÙŠÙ„ Ù…Ø±Ø§Ù‚Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ÙŠØ´Ù…Ù„ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¯ÙŠØ± ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
    auth.onAuthStateChanged(async user => {
        const overlay = document.getElementById('login-overlay');
        const emailDisplay = document.getElementById('user-email-display');
        
        if(user) {
            try {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ù…Ø¯ÙŠØ±ØŒ Ø§Ø¹Ø·Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ØµÙ„Ø§Ø­ÙŠØ© Admin ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                await ensureAdminExists(user.email);

                // 1. Ø¬Ù„Ø¨ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯)
                const userDoc = await db.collection('app_users').doc(user.email).get();
                
                if (userDoc.exists) {
                    currentUserRole = userDoc.data().role;
                } else {
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙˆÙ„ÙŠØ³ Ù…Ø¯ÙŠØ±Ø§Ù‹)ØŒ Ù†Ù…Ù†Ø­Ù‡ Ø¯ÙˆØ± viewer Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
                    currentUserRole = 'viewer'; 
                }

                // 2. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                applyPermissions(currentUserRole);

                // 3. Ø§Ù„Ø¯Ø®ÙˆÙ„
                overlay.style.display = 'none';
                if(emailDisplay) emailDisplay.innerText = `${user.email} (${getRoleName(currentUserRole)})`;
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¯ÙŠØ± ÙØªØ­ Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙØ¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                if (currentUserRole === 'admin') {
                    loadUsersList();
                }

                updateDashboardStats(); 
            } catch (err) {
console.error("Auth state handling error:", err);
alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:\n" + err.message); // Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø³ÙŠØ®Ø¨Ø±Ùƒ Ø¨Ø§Ù„Ø³Ø¨Ø¨
overlay.style.display = 'flex';

            }
        } else {
            overlay.style.display = 'flex';
        }
    });

    // Ø¯Ø§Ù„Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø±) â€” ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙÙ‚Ø·
   // ...existing code...
function applyPermissions(role) {
    // Ø£Ø®ÙÙ ÙƒÙ„ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹
    document.querySelectorAll('.nav-menu li').forEach(li => li.style.display = 'none');

    // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
    const salesBtn = document.querySelector('button[onclick*="p-sales-report"]');
    if (salesBtn && salesBtn.parentElement) {
        salesBtn.parentElement.style.display = 'block';
        salesBtn.style.display = 'flex';
    }
    
   const analyticsBtn = document.querySelector('button[onclick*="p-analytics"]');
        if (analyticsBtn && analyticsBtn.parentElement) {
            analyticsBtn.parentElement.style.display = 'block';
            analyticsBtn.style.display = 'flex';
        }
 
 
     // âœ… Ø¥Ø¶Ø§ÙØ© Ø¥Ø¸Ù‡Ø§Ø± ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ Ø£ÙŠØ¶Ø§Ù‹
        const btnAnalytics = document.querySelector("button[onclick*='p-analytics']");
        if (btnAnalytics && btnAnalytics.parentElement) btnAnalytics.parentElement.style.display = 'block';

        
    // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø£Ù…Ø§Ù† (Ù„ÙˆØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬) Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ ÙˆØ§Ù„Ù…Ø­Ø±Ø± Ø£ÙŠØ¶Ø§Ù‹
    const logoutBtn = document.querySelector('button[onclick="handleLogout()"]');
    if (logoutBtn && logoutBtn.parentElement) {
        logoutBtn.parentElement.style.display = 'block';
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ùˆ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ù„ÙˆØ§Ø­: Ø§Ø¬Ø¹Ù„ Ù„ÙˆØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù†Ø´Ø·Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    const salesPanel = document.getElementById('p-sales-report');
    if (salesPanel) salesPanel.classList.add('active');

    // Ø£Ø®ÙÙ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­ÙØ¸/ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù Ø¹Ø§Ù…Ø© Ù…Ø¹ Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ¯Ø§Ø®Ù„ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ù…Ø§Ù† (ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬)
    document.querySelectorAll('.btn-save, .btn-update, .btn-red').forEach(b => {
        if (b.closest && (b.closest('#p-sales-report') || b.closest('#p-security'))) return;
        b.style.display = 'none';
    });
const allowedPanels = ['p-sales-report', 'p-analytics'];
        allowedPanels.forEach(panelId => {
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.querySelectorAll('.btn').forEach(btn => {
                    btn.style.display = 'inline-flex'; 
                });
            }
        });

    // Ø§Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ¨Ø§Ù‚ÙŠ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… Ø®Ø§Ø±Ø¬ Ù„ÙˆØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (ÙˆØ§Ø³ØªØ«Ù†Ø§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ù…Ø§Ù†)
    document.querySelectorAll('input[type="file"], .form-grid input[disabled-hidden]').forEach(el => {
        if (el.closest && (el.closest('#p-sales-report') || el.closest('#p-security'))) return;
        el.style.display = 'none';
    });

    // Ø¥Ø®ÙØ§Ø¡ ÙƒØ§Ø±Øª "Ø¨Ù„Ø§ ØµÙˆØ±" Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ ÙˆØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„ÙŠÙ‡
    const noImgCard = document.querySelector('.stat-card.clickable');
    if (role === 'viewer') {
        if (noImgCard) {
            noImgCard.style.display = 'none';
            noImgCard.style.pointerEvents = 'none';
            noImgCard.removeAttribute('onclick');
        }
        try { loadSalesReports(); } catch (e) { console.error(e); }
        return;
    }
    

    // Ù„Ù„Ù…Ø­Ø±Ø±/Ø§Ù„Ù…Ø¯ÙŠØ±: Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© ÙƒØ§Ø±Øª "Ø¨Ù„Ø§ ØµÙˆØ±"
    if (role === 'editor' || role === 'admin') {
        document.querySelectorAll('.nav-menu li').forEach(li => li.style.display = 'block');
        document.querySelectorAll('.btn-save, .btn-update, .btn-red').forEach(b => b.style.display = 'flex');
        if (noImgCard) {
            noImgCard.style.display = 'block';
            noImgCard.style.pointerEvents = 'auto';
            noImgCard.setAttribute('onclick', 'filterNoImageProducts()');
        }
    }

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¯ÙŠØ±ØŒ Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        if (role === 'admin') {
            const usersBtn = document.querySelector('button[onclick*="p-users"]');
            if (usersBtn && usersBtn.parentElement) {
                usersBtn.parentElement.style.display = 'block';
                usersBtn.style.display = 'flex';
            }
        }
    }

    // Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ù…Ø­Ø¯Ø¯ Ø¹Ø¨Ø± Ù…Ø¹Ø±Ù Ø§Ù„Ù„ÙˆØ­Ø© (ÙŠÙØªØ±Ùƒ Ø¥Ù† Ù„Ø²Ù…)
    function hideNav(panelId) {
        const btn = document.querySelector(`button[onclick*="${panelId}"]`);
        if(btn && btn.parentElement) btn.parentElement.style.display = 'none';
    }

    function getRoleName(role) {
        if(role === 'admin') return 'Ù…Ø¯ÙŠØ± ÙƒØ§Ù…Ù„';
        if(role === 'editor') return 'Ù…Ø­Ø±Ø±';
        if(role === 'viewer') return 'Ù…Ø´Ø§Ù‡Ø¯';
        return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    }

    // ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Backend Logic)
    // ===============================
    
    // Ø­ÙØ¸/ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªØ®Ø¯Ù…
    async function saveUserRole() {
        if(currentUserRole !== 'admin') return alert("â›” Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø§ØµÙŠØ© Ù„Ù„Ù…Ø¯Ø±Ø§Ø¡ ÙÙ‚Ø·!");

        const email = document.getElementById('u-email').value.toLowerCase().trim();
        const role = document.getElementById('u-role').value;

        if(!email) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ");

        try {
            await db.collection('app_users').doc(email).set({
                email: email,
                role: role,
                updatedAt: Date.now(),
                updatedBy: auth.currentUser.email
            });
            alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
            document.getElementById('u-email').value = '';
            loadUsersList();
        } catch(e) {
            alert("âŒ Ø®Ø·Ø£: " + e.message);
        }
    }

    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    function loadUsersList() {
        const listDiv = document.getElementById('users-list');
        db.collection('app_users').onSnapshot(snap => {
            listDiv.innerHTML = snap.docs.map(doc => {
                const d = doc.data();
                return `
                <div style="background:#fff; padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>${d.email}</strong>
                        <span style="background:#e0f2fe; color:#0284c7; padding:2px 8px; border-radius:10px; font-size:11px;">${getRoleName(d.role)}</span>
                    </div>
                    <button onclick="deleteUserRole('${doc.id}')" class="btn btn-red" style="width:auto; padding:5px;"><i class="fas fa-trash"></i></button>
                </div>`;
            }).join('');
        });
    }

    // Ø­Ø°Ù ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø³ØªØ®Ø¯Ù…
    async function deleteUserRole(email) {
        if(currentUserRole !== 'admin') return alert("â›” Ù„Ù„Ù…Ø¯Ø±Ø§Ø¡ ÙÙ‚Ø·");
        if(confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ØµÙ„Ø§Ø­ÙŠØ§Øª ${email}ØŸ`)) {
            await db.collection('app_users').doc(email).delete();
        }
    }

    // ØªØ´ØºÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù‚Ø³Ù…
    document.getElementById('nav-users').addEventListener('click', loadUsersList);


 // ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª + ØªØµØ¯ÙŠØ± Excel 
    // =============================
  // 1. Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…
    let allSales = [];

    // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…Ø¹ Ø§Ù„Ù…Ø¹Ø±Ù ID)
    async function loadSalesReports() {
        const tbody = document.getElementById('sales-report-body');
        const filterBranch = document.getElementById('filter-branch').value.toLowerCase();
        
        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...</td></tr>';

        try {
            const snap = await db.collection('sales_transactions')
                                 .orderBy('createdAt', 'desc')
                                 .limit(100)
                                 .get();
            
            if (snap.empty) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px; color:#666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
                document.getElementById('total-sales-display').innerText = "0 Ø¬.Ù…";
                allSales = [];
                return;
            }

            // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª + Ø§Ù„Ù€ ID Ø§Ù„Ø®Ø§Øµ Ø¨ÙƒÙ„ Ù…Ø³ØªÙ†Ø¯
            allSales = snap.docs.map(d => ({
                id: d.id, // Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ù‡Ù… Ù„Ù„Ø­Ø°Ù
                ...d.data()
            }));
            
            renderSalesTable(allSales, filterBranch);
            
        } catch(e) {
            console.error(e);
            tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:red;">Ø®Ø·Ø£: ${e.message}</td></tr>`;
        }
    }

    // 3. Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ù…Ø¹ Ø²Ø± Ø­Ø°Ù Ù„ÙƒÙ„ Ù…Ù†ØªØ¬)
    function renderSalesTable(sales, branchFilter) {
        const tbody = document.getElementById('sales-report-body');
        let grandTotal = 0; 
        const groupedSales = {};

        sales.forEach(s => {
            const rawBranch = s.branch ? s.branch.trim() : 'ÙØ±Ø¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            if (branchFilter && !rawBranch.toLowerCase().includes(branchFilter)) return;

            if (!groupedSales[rawBranch]) {
                groupedSales[rawBranch] = { name: rawBranch, items: [], branchTotal: 0 };
            }
            // Ù†Ù…Ø±Ø± Ø§Ù„ÙƒØ§Ø¦Ù† ÙƒØ§Ù…Ù„Ø§Ù‹ (Ø¨Ù…Ø§ ÙÙŠÙ‡ id)
            groupedSales[rawBranch].items.push(s);
            groupedSales[rawBranch].branchTotal += Number(s.price) || 0;
            grandTotal += Number(s.price) || 0;
        });

        const branchNames = Object.keys(groupedSales);
        if(branchNames.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
            document.getElementById('total-sales-display').innerText = "0 Ø¬.Ù…";
            return;
        }

        tbody.innerHTML = branchNames.map(bName => {
            const branch = groupedSales[bName];
            
            const productsListHTML = branch.items.map(item => 
                `<div style="border-bottom:1px dashed #eee; padding:5px 0; display:flex; justify-content:space-between; align-items:center;">
                    <div style="flex:1;">
                        <span style="color:#666; font-size:11px;">[${item.date}]</span>
                        <span style="font-weight:bold; color:#333;">${item.product}</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="color:#10b981;">${Number(item.price).toLocaleString()} Ø¬.Ù…</span>
                        <!-- Ø²Ø± Ø§Ù„Ø­Ø°Ù Ù„Ù„Ù…Ø¯ÙŠØ± -->
                        <button onclick="deleteSaleFromDashboard('${item.id}')" title="Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬" 
                                style="background:#fee2e2; color:#ef4444; border:none; width:20px; height:20px; border-radius:50%; cursor:pointer; font-size:12px; line-height:1;">
                            Ã—
                        </button>
                    </div>
                 </div>`
            ).join('');

            return `
            <tr style="border-bottom:2px solid #e2e8f0; background:#fff;">
                <td style="padding:15px; vertical-align:top; border-left:1px solid #eee;">
                    <div style="font-weight:800; color:#1a73e8; font-size:14px;">ğŸª ${branch.name}</div>
                    <div style="font-size:11px; color:#888; margin-top:5px;">Ø¹Ø¯Ø¯: ${branch.items.length}</div>
                </td>
                <td style="padding:10px; vertical-align:top; border-left:1px solid #eee; background:#f8fafc;">
                    ${productsListHTML}
                </td>
                <td style="padding:15px; vertical-align:middle; text-align:center; font-weight:bold; color:#059669; font-size:15px;">
                    ${branch.branchTotal.toLocaleString()} Ø¬.Ù…
                </td>
            </tr>`;
        }).join('');

        document.getElementById('total-sales-display').innerText = grandTotal.toLocaleString() + " Ø¬.Ù…";
    }

    // 4. Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø¯ÙŠØ±
    async function deleteSaleFromDashboard(docId) {
        if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ØŸ")) return;
        
        try {
            await db.collection('sales_transactions').doc(docId).delete();
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
            loadSalesReports();
        } catch(e) {
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: " + e.message);
        }
    }

// Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Excel
    function downloadSalesReportExcel() {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª
        if(!allSales || allSales.length === 0) {
            alert("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª' Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„Ø§Øª.");
            return;
        }

        // 1. ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥ÙƒØ³ÙŠÙ„
        // Ù†Ù‚ÙˆÙ… Ø¨ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹ Ù„ØªÙƒÙˆÙ† Ù…Ù†Ø¸Ù…Ø©
        const sortedSales = allSales.sort((a, b) => {
            const branchA = (a.branch || "").toLowerCase();
            const branchB = (b.branch || "").toLowerCase();
            if (branchA < branchB) return -1;
            if (branchA > branchB) return 1;
            return 0;
        });

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø´ÙƒÙ„ Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø¥ÙƒØ³ÙŠÙ„ (Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ)
        const excelData = sortedSales.map(s => ({
            "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„ÙŠØ©": s.date,
            "Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹": s.branch || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
            "Ø§Ù„Ù…Ù†ØªØ¬": s.product,
            "Ø§Ù„Ø³Ø¹Ø± (Ø¬.Ù…)": Number(s.price) || 0
        }));

        // 2. Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ (Worksheet)
        const ws = XLSX.utils.json_to_sheet(excelData);

        // ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ø¬Ù…Ø§Ù„ Ø§Ù„Ø´ÙƒÙ„)
        const wscols = [
            {wch: 15}, // Ø§Ù„ØªØ§Ø±ÙŠØ®
            {wch: 25}, // Ø§Ù„ÙØ±Ø¹
            {wch: 30}, // Ø§Ù„Ù…Ù†ØªØ¬
            {wch: 15}  // Ø§Ù„Ø³Ø¹Ø±
        ];
        ws['!cols'] = wscols;

        // 3. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù ÙˆØ­ÙØ¸Ù‡
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª");
        
        // Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
        const dateStr = new Date().toISOString().slice(0,10);
        XLSX.writeFile(wb, `Sales_Report_${dateStr}.xlsx`);
    }
    // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª 
async function sendNotification() {
    if(!auth.currentUser) return alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");

    const msg = document.getElementById('notifyMsg').value;
    const type = document.getElementById('notifyType').value;
    const isActive = document.getElementById('notifStatus').value === "true";

    try {
        await db.collection("app_config").doc("notifications").set({
            message: msg,
            type: type, // info, warning, danger
            active: isActive,
            updatedAt: Date.now()
        });
        alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
    } catch(e) {
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: " + e.message);
    }
}

// ÙƒÙˆØ¯ Ù„Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù„ÙˆØ­Ø© (Ù„ØªØ¹Ø±Ù Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©)
db.collection("app_config").doc("notifications").onSnapshot(doc => {
    if(doc.exists) {
        const d = doc.data();
        document.getElementById('notifyMsg').value = d.message || "";
        document.getElementById('notifyType').value = d.type || "info";
        document.getElementById('notifStatus').value = d.active ? "true" : "false";
    }
});
// Ù…ØªØºÙŠØ±Ø§Øª Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„ÙƒØ§Ø±ØªØ§Øª Ø­ØªÙ‰ Ù„Ø§ ÙŠØ­Ø¯Ø« ØªØ¯Ø§Ø®Ù„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
let charts = {}; 

async function calculateAnalytics() {
    // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const snap = await db.collection('sales_transactions').get();
    if (snap.empty) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ­Ù„ÙŠÙ„");

    const data = snap.docs.map(d => d.data());

    // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    let branchSales = {};
    let productCounts = {};
    let totalRevenue = 0;

    data.forEach(item => {
        const price = Number(item.price) || 0;
        const branch = item.branch || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        const product = item.product || "Ù…Ù†ØªØ¬ Ù…Ø¬Ù‡ÙˆÙ„";

        // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹
        branchSales[branch] = (branchSales[branch] || 0) + price;
        
        // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ø¨Ø§Ù„Ø¹Ø¯Ø¯)
        productCounts[product] = (productCounts[product] || 0) + 1;

        totalRevenue += price;
    });

    // ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
    document.getElementById('total-revenue-analytics').innerText = totalRevenue.toLocaleString() + " Ø¬.Ù…";

    // 3. ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø±Ø³Ù…
    // Ø§Ù„ÙØ±ÙˆØ¹
    const branchLabels = Object.keys(branchSales);
    const branchData = Object.values(branchSales);

    // Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (ØªØ±ØªÙŠØ¨ ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹)
    const sortedProducts = Object.entries(productCounts).sort((a, b) => b[1] - a[1]);
    
    // Ø£Ø¹Ù„Ù‰ 5
    const top5 = sortedProducts.slice(0, 5);
    // Ø£Ù‚Ù„ 5 (Ù†Ø£Ø®Ø° Ù…Ù† Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙˆÙ†Ø¹ÙƒØ³ Ø§Ù„ØªØ±ØªÙŠØ¨)
    const low5 = sortedProducts.slice(-5).reverse();

    // 4. Ø±Ø³Ù… Ø§Ù„Ø¬Ø±Ø§ÙØ§Øª (Charts)
    renderChart('branchChart', 'bar', branchLabels, branchData, 'Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹ (Ø¬Ù†ÙŠØ©)', ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']);
    renderChart('topProductsChart', 'doughnut', top5.map(i=>i[0]), top5.map(i=>i[1]), 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5']);
    renderChart('lowProductsChart', 'pie', low5.map(i=>i[0]), low5.map(i=>i[1]), 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', ['#ef4444', '#f87171', '#fca5a5', '#fecaca', '#fee2e2']);
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³Ù… ÙˆØªØ¯Ù…ÙŠØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…
function renderChart(canvasId, type, labels, data, label, colors) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    if (charts[canvasId]) {
        charts[canvasId].destroy(); // ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¯Ø§Ø®Ù„
    }

    charts[canvasId] = new Chart(ctx, {
        type: type,
        data: {
            labels: labels,
            datasets: [{
                label: label,
                data: data,
                backgroundColor: colors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}
// === Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© ÙƒÙˆØ¯ Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ===
// 1. Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
db.collection("app_config").doc("access_control").onSnapshot(doc => {
    if(doc.exists && doc.data().searchPageCode) {
        const input = document.getElementById('appAccessCode');
        if(input) input.value = doc.data().searchPageCode;
    }
});

// 2. Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
async function saveAppAccessCode() {
    if(!auth.currentUser) return alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (ÙŠÙ…ÙƒÙ†Ùƒ ØªÙØ¹ÙŠÙ„Ù‡Ø§ Ù„Ù„Ù…Ø¯Ø±Ø§Ø¡ ÙÙ‚Ø·)
    // if(currentUserRole !== 'admin') return alert("Ù„Ù„Ù…Ø¯Ø±Ø§Ø¡ ÙÙ‚Ø·");

    const newCode = document.getElementById('appAccessCode').value.trim();
    if(!newCode) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© ÙƒÙˆØ¯");

    try {
        await db.collection("app_config").doc("access_control").set({
            searchPageCode: newCode,
            updatedAt: Date.now(),
            updatedBy: auth.currentUser.email
        }, {merge: true});
        alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡ ÙÙˆØ±Ø§Ù‹ Ø¹Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø«.");
    } catch(e) {
        alert("Ø®Ø·Ø£: " + e.message);
    }
}

</script>
</body>
</html>
